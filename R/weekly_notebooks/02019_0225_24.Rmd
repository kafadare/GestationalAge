---
title: "0219_0225"
author: "Eren Kafadar"
date: "2024-02-19"
output: html_document
---
# Thoughts on this week
Running the model with preterm status as a fixed variable does not seem to work. First priority from analysis angle is to get this working. Look at gamlss exercises, and potentially other code that predicts centile scores (is there a braincharts paper github?).
Priority from QC angle is to read the Ss paper thoroughly, looking out for QC stuff.
Create the growthchart plots Aaron asked for, binned by different scan types & within subject/session medians: if we can use "median" scan per subject/session instead of having to sort scans, this would make pipeline so much easier!! Intrasubject correlation (especially of the centile scores once I get there - see below.)
2/21 - waiting to hear back from Slack channel on the gamlss error.
Discussed with Aaron looking at ABCD data while waiting for SLIP data to accummulate.
Considering fitting a model the the "early age" data in the SLIP + LBCC sample. Starting 0 = conception.

LBCC-SLIP stuff.
There are already "Slip" data inside the LBCC consortium.
- look at these datapoints to see if they are ALL the scans, or else how are there >1700 data points there?
- get data specifically from "earlier life" age ranges (look into specific studies for this)
- Also, is the SLIP data in the lbcc file Lena sent Freesurfer segmentations??

To fix inside functions
- for output of predictCentiles: only one logAge column. Save the number of "centile" inside the list element too.
- fix ageAtPeaks code so that it works with the the predictCentiles output.
- Make plotting into a function on its own (inside the figures script!)

To look at Feb 23 - Feb 25 WeekEnd
-Medians auto-correlation, centile scores & raw.
-try to get growthChart with GA bins fixed variable. In Lbcc-slip together data.
  - All of it
  - Focus on early lifen (0-2/5 years?)
  - Only ABCD???
-Get ABCD data from Respublica locally (through Box?) ... which .csvS exactly??
-Normative modeling?
  -Sounds fun, but a little too ambitious for the weekend perhaps?

Also Still Need To:
-Read Ss paper!!
-Look at fsleyes segmentations of VERY BAD segmentations (infants) with low autoQC scores

**BIG Q - currently logAge is from adjusted age. Should I use adjusted or non-adjusted when modeling for GA effect? Think about this.**
#Aaron mtg 02/21
correlate MPR and non-MPR scans within subset that has MPR
looking at centiles instead of the raw value eventually by scan type
dataCamp channel for Ss and FreeSurfer names

ABCD brain-first, have they "caught up" vs not analysis
gamlss models not fit with a random effect for subject, so doesn't account for "longitudinal data" (??)
Not trivial to get centile scores on longitudinal data
How surprised are we about where you are given you were in a specific spot earlier?
Growth charts that account for change in trajectory, is this amount of change normal?

***

This is the script from Jenna's github that would be a helpful place to start to build gamlss models. There should also be Jakob's scripts that are more complicated but provide more flexibility (this is my understanding) in choosing a model.
https://github.com/jmschabdach/mpr_analysis/blob/develop/r/build_your_own_growth_chart.R

***

Notes on Jenna Code
- FreeSurfer model includes SurfaceHoles variable in model, not applicable in SynthSeg output.
- logAge: numeric type with log(post conception age in days, base=10). In (1), we use a conversion factor of 325.25 days/year and a post conception offset of 280 days if post conception age is not available.
#Setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(magrittr)
library(table1)
library(ggplot2)
library(rlang)
library(viridis)
library(gridExtra)
library(purrr)
library(cowplot)
library(gamlss) #to fit model
library(mgcv) # helps with the gam models
library(tidymv) # helps with the gam models

#setwd("/Users/ekafadar/Documents/Grad_School/BGDLab/GestationalAge/")
source("/Users/ekafadar/Documents/Grad_School/BGDLab/GestationalAge/R/scripts/data_functions.R")
source("~/Documents/Grad_School/BGDLab/GestationalAge/R/scripts/lib_mpr_analysis_EK.r")
source("~/Documents/Grad_School/BGDLab/GestationalAge/R/scripts/growth_chart_fcts_EK.r")
source("~/Documents/Grad_School/BGDLab/GestationalAge/R/scripts/figures.r")

folders <- c("/Users/ekafadar/Documents/Grad_School/BGDLab/SLIP_data/2024-01-19_release/slip_2022/","/Users/ekafadar/Documents/Grad_School/BGDLab/SLIP_data/2024-01-19_release/slip_2023_02/", "/Users/ekafadar/Documents/Grad_School/BGDLab/SLIP_data/2024-01-19_release/slip_2023_03/")
manual_qc_file <- "/Users/ekafadar/Documents/Grad_School/BGDLab/SLIP_data/manual_qc_grades_radiology_paper.csv"
lbcc_ga_file <- "~/Documents/Grad_School/BGDLab/LBCC_data/GA.all.data-24-02.csv"
```

# Play - SLIP
## Load Data
Data Jenna sent is in 3 folders by release date
There are 3 files in each folder
- qc scores csv % synthseg volumes csv -- 2155 unique subject_ids, and 11267 unique data points (subject + age at scan?)
- participants tsv -- 2173 total data

Put all the data together from three releases and merge the qc scores, volumes, and participant data
Save this full dataset
###Load all csv data and merge
```{r}
participants <- load_data(names = c(paste0("data",1:3)), paste0(folders,"participants.tsv")) %>% bind_rows(.)
qc_scores <- load_data(names = c(paste0("data",1:3)), paste0(folders,"synthseg+_qc_scores.csv")) %>% bind_rows(.)
volumes <- load_data(names = c(paste0("data",1:3)), paste0(folders,"synthseg+_volumes.csv")) %>% bind_rows(.)
colnames(qc_scores) <- c(paste0(names(qc_scores[1:8])),paste0(names(qc_scores[9:length(names(qc_scores))]),"_qc"))
qc_manual <- load_data(names = "qc", manual_qc_file) %>% bind_rows(.)
qc_manual$full_path <- qc_manual$scan_id
qc_manual$scan_id <- gsub("(?:.*/){10}", "\\1", qc_manual$full_path) %>% sub("\\.nii\\.gz$", "", .)
#merge
full_data <- merge(qc_scores, volumes, by = intersect(names(qc_scores), names(volumes)))
full_data <- merge(full_data, participants, by = intersect(names(full_data), names(participants)))
write.csv(full_data, file = "/Users/ekafadar/Documents/Grad_School/BGDLab/SLIP_data/SLIP_combined_011923.csv", quote = F, row.names = F)
```

###Load full data
adjust variables: log10 age, get minQC column
2/12 Fix adjusted age. Original df was adding GA in weeks to age at scan in days.
Now we are
adding GA x 7 + age at scan
if GA not available, then adding 280 + age at scan (for assuming a 40week term pregnancy) -- just so there is no NAs in the column, but in actuality we don't know if these scans were full-term or not.
```{r}
qc_manual <- load_data(names = "qc", manual_qc_file) %>% bind_rows(.)
qc_manual$full_path <- qc_manual$scan_id
qc_manual$scan_id <- gsub("(?:.*/){10}", "\\1", qc_manual$full_path) %>% sub("\\.nii\\.gz$", "", .)
full_data <- read.csv("/Users/ekafadar/Documents/Grad_School/BGDLab/SLIP_data/SLIP_combined_011923.csv") 
full_data <- full_data %>% mutate(sex = as.factor(sex)) %>% rowwise() %>% 
  mutate(minQC = min(c_across(contains("qc"))))
full_data$adjusted_age_in_days <- ifelse(!is.na(full_data$gestational_age), (full_data$age_at_scan + (full_data$gestational_age*7)), full_data$age_at_scan + 280)
levels(full_data$sex) <- c("F", "M") #male = 0, female = 1
full_data$logAge <- log10(full_data$adjusted_age_in_days)
```

###Split data by scan type, ageBin
```{r}
full_data$scan_type <- as.factor(ifelse(grepl("MPR", full_data$scan_id), "MPR", ifelse((!grepl("MPR", full_data$scan_id) & grepl("T1w", full_data$scan_id)), "T1w_other", ifelse(grepl("T2w", full_data$scan_id), "T2w", ifelse(grepl("FLAIR", full_data$scan_id), "flair", NA)))))
full_data$ageBin <- cut(full_data$age_at_scan, breaks = c(-Inf, 30, 365, 1095, 2190, 4380, Inf), labels = c("Newborn", "Infant", "Toddler", "Preschool", "School_Age", "Adolescent"), include.lowest = TRUE)
#df_MPR <- full_data[grepl("MPR", full_data$scan_id),] %>% distinct(subject_id, .keep_all = T)#947

#df_T1w <- full_data[!grepl("MPR", full_data$scan_id) & grepl("T1w", full_data$scan_id),] %>% distinct(subject_id, .keep_all = T)#1743

#df_T2w <- full_data[grepl("T2w", full_data$scan_id),] %>% distinct(subject_id, .keep_all = T)#1021

#table(grepl("FLAIR",full_data$scan_id))#891
table(full_data$scan_type)
```
1229 MPR scans, 947 unique subject ids
6519 T1w non-MPR scans, 1743 unique subject ids
2628 T2w scans, 1021 unique subject ids
891 FLAIR scans
-All 11267 scans accounted for above.

###Separate df w/ GA
Use scans with MPR. df_MPR
!!! Noticed on 2/6/24 that the cut-offs were inclusive, so changed them to 31.9 and 36.9, this will change the #s of subjects for the categories down the line. So should re-run things!!
```{r}
all_GA_data <- subset(full_data, !is.na(gestational_age))#358
GA_data <- subset(filter(full_data, scan_type == "MPR"), !is.na(gestational_age)) %>% distinct(subject_id, .keep_all = T)#358
GA_data$log_GA <- log10(GA_data$gestational_age)
#Split in GA bins
# Determine the cut points based on quantiles
cut_points <- quantile(GA_data$gestational_age, probs = c(1/3, 2/3)) # cut points are 39 and 40. So this will NOT work.

cut_points <- quantile(GA_data$log_GA, probs = c(1/3, 2/3)) # cut points are 1.59 and 1.6. So this will NOT work.

# Create a new column indicating cut points: specifying by weeks.
GA_data$preterm <- cut(GA_data$gestational_age, breaks = c(-Inf, 31.9, 36.9, Inf), labels = c("VPM", "LPM", "Term"), include.lowest = TRUE)
table(GA_data$preterm)
table(GA_data$sex)
table(all_GA_data$scan_type)
```
## QC Scores
###General QC notes
synthseg QC scores is like a predicted dice coef, based on trained models, only trained for some values.
this QC might not be good enough, might have to go back and do some QC
Synthseg is hierarchical, ie finds cortex and then finds regions between them
**Confirm with Jakob, 0.65 across every single one (all should be above 0.65 within a sample) Might need to do some sensitivity analyses.**

Expectation: A higher proportion of data would have GA if its for people under < 5, with only more recent scans
Look at QC scores for variables which include QC scores:
 * general WM
 * general GM
 * general CSF
 * cerebellum
 * brainstem
 * thalamus
 * putamen.pallidum
 * hippocampus.amygdala
 
###Values
```{r}
table(filter(full_data, minQC >= 0.65)$scan_type)
table(filter(all_GA_data, minQC >= 0.65)$scan_type)

table(filter(full_data, minQC >= 0.65)$scan_type)
dim(full_data %>% filter(minQC >= 0.65) %>% distinct(subject_id))
table(filter(all_GA_data, minQC >= 0.65)$scan_type)
dim(all_GA_data %>% filter(minQC >= 0.65) %>% distinct(subject_id, .keep_all = T) %>% filter(scan_type == "MPR"))
```

###Manual QC and Auto QC similarity?
SLIP paper used average QC >= 1.0
Odds Ratio?
For the full dataset
```{r}
df <- merge(full_data, qc_manual,by = c("scan_id")) 
table(df$scan_type)
plot(df$rawdata_image_grade, df$minQC, main = "all, n = 472")
df_MPR <- df %>% filter(scan_type == "MPR")#273
plot(df_MPR$rawdata_image_grade, df_MPR$minQC, main = "within MPR, n = 273")
ggplot(df, aes(x=minQC, fill = as.factor(rawdata_image_grade))) + geom_histogram(bins = 20) + scale_x_continuous(breaks = pretty(df$minQC, n = 10)) + theme_minimal() + ggtitle("All data with QC, n = 472")
ggplot(df_MPR, aes(x=minQC, fill = as.factor(rawdata_image_grade))) + geom_histogram(bins = 20) + scale_x_continuous(breaks = pretty(df$minQC, n = 10)) + theme_minimal() + ggtitle("MPR data with QC, n = 273")


plot(df$rawdata_image_grade, df$age_at_scan_days, main =  "all, n = 472")
ga_num <- sum(!is.na(df$gestational_age))
plot(df$rawdata_image_grade, df$gestational_age, main =  paste0("all, n = ", ga_num))
##
#df_MPR <- df %>% filter(scan_type == "MPR")%>% distinct(subject_id.x, .keep_all = T)#273 of them
plot(df_MPR$minQC, df_MPR$rawdata_image_grade)
cor.test(df_MPR$minQC, df_MPR$rawdata_image_grade)
cor.test(df$minQC, df$rawdata_image_grade)
sum(df_MPR$rawdata_image_grade >= 1) #222/273 using manual
sum(df_MPR$minQC >= 0.65)#191/273 using SS auto
sum(df_MPR$minQC >= 0.60)#266/273 using SS auto

#plot overlap, by scan type
hist(df$minQC)
ggplot(df, aes(x=minQC, fill = as.factor(rawdata_image_grade))) + geom_histogram(bins = 20) + scale_x_continuous(breaks = pretty(df$minQC, n = 10)) + theme_minimal() + ggtitle("All data with QC, n = 472") + facet_wrap(~scan_type, nrow = 2)

#plot overlap, by age bin
ggplot(df_MPR, aes(x=minQC, fill = as.factor(rawdata_image_grade))) + geom_histogram(bins = 20) + scale_x_continuous(breaks = pretty(df$minQC, n = 10)) + theme_minimal() + ggtitle("MPR data with QC, n = 273") + facet_wrap(~ageBin, nrow = 2)

#plot overlap, by ageXscan
ggplot(df, aes(x=minQC, fill = as.factor(rawdata_image_grade))) + geom_histogram(bins = 20) + scale_x_continuous(breaks = pretty(df$minQC, n = 10)) + theme_minimal() + ggtitle("All data with QC, n = 472") + facet_wrap(~ageBin+scan_type, nrow = 3)

```
For the GA data
odds ratio of being high QC under SS when high QC under manual is 2.43 (with SS value at 0.65)
2.35 with SS value at 0.6
80/101 pass manual QC, 56/101 pass SS auto QC (at 0.65)
```{r}
df <- merge(GA_data, qc_manual,by = c("scan_id"))#66 obs, all MPR
plot(df$minQC, df$rawdata_image_grade)
cor.test(df$minQC, df$rawdata_image_grade)
sum(df$rawdata_image_grade >= 1) #52/66 using manual
sum(df$minQC >= 0.65)# 49/66 using SS auto

#plot overlap
hist(df$minQC)
ggplot(df, aes(x=minQC, fill = as.factor(rawdata_image_grade))) + geom_histogram(bins = 20) + scale_x_continuous(breaks = pretty(df$minQC, n = 10)) + theme_minimal() + ggtitle("GA data with QC, n = 66")
```
 ***
Logistic regression to predict manual QC value from SS auto QC
- minQC IS a sig predictor ( p = 0.119, beta est = 4.5) of "pass" status in manual QC --- using only the MPR scans
```{r}
df_MPR <- full_data %>% group_by(scan_type) %>% distinct(subject_id, .keep_all = T) %>% filter(scan_type == "MPR")
df <- merge(df_MPR, qc_manual,by = c("scan_id")) %>% mutate(manual_QC_pass = rawdata_image_grade >= 1)
df$manual_QC_pass<- factor(df$manual_QC_pass)
logit <- glm(manual_QC_pass ~ minQC, data = df, family = "binomial")
summary(logit)
```

 ***
Notes after impromptu meeting with Jenna on 01/31 on QC stuff
GM/CSF/WM -- could just be sums? Is QC value an average of these sums? Doesn't seem likely given the distributions.
There is specific QC ratings for the manual ratings in the respublika folder for the SLIP radiology paper. This could be useful to look at specific ratings of the images.
The specific images used to rate are also in this folder I think

 ***
###Looking at Individual Scans
Take a look at individual scans that have
- borderline auto QC 0.6/0.65
- mismatched auto & manual QC
- mid-low auto QC 0.2-0.4
Look at about ~2-3 scans from each category in fsl viewer on Respublika
Screenshot them for google slides.
Choosing the scans to be looked at:
``` {r}
borderline_autoQC <- filter(GA_data, minQC < 0.65 & minQC >= 0.55)
df <- merge(GA_data, qc_manual,by = c("subject_id", "session_id"))
mismatch_QC_mnPS <- filter(df, rawdata_image_grade >= 1 & minQC < 0.65)
mismatch_QC_ssPS <- filter(df, rawdata_image_grade < 1 & minQC >= 0.65)
midlow_autoQC <- filter(GA_data, minQC < 0.4 & minQC > 0.2)
set.seed(42)
s1 <- borderline_autoQC[sample(nrow(borderline_autoQC), 1, replace = FALSE), ]
s2 <-mismatch_QC_mnPS[sample(nrow(mismatch_QC_mnPS), 1, replace = FALSE), ]
s3 <-mismatch_QC_ssPS[sample(nrow(mismatch_QC_ssPS), 1, replace = FALSE), ]
s4 <-midlow_autoQC[sample(nrow(midlow_autoQC), 1, replace = FALSE), ]
full_data[which(full_data$minQC == max(full_data$minQC)),]
full_data[which(full_data$minQC > 0.75 & full_data$adjusted_age_in_days < 1500),]
s4
```
Max Min QC 0.7655
slip 2023-03 sub-HM14RHXMW_ses-201050308439procId006006ageDays_acq-MPR_run-001_T1w $\checkmark$
adj age 6286 days

High QC 0.7531 age 1399 days
slip 2022 sub-HM18OTNFZ_ses-325726739876procId001362ageDays_acq-TSE_run-001_T1w $\checkmark$

Borderline
slip 2023-03 sub-HM36EP5TB_ses-297207596745procId001242ageDays_acq-TSE_run-002_T1w $\checkmark$
minQC 0.6318
adj age 1281 days

slip 2023-02 	sub-HM34S3Z1_ses-95046832730procId000534ageDays_run-001_T2w
minQC 0.6445
adj age 573 days

slip 2023-02 	sub-HM1WCY4QA_ses-186586445493procId003011ageDays_run-002_FLAIR
minQC 0.6284
adj age 3051 days


Midlow
23-03
age 1065days
minQC 0.3952
sub-HM1WEGOWD_ses-320995680774procId001027ageDays_run-003_T2w
**^ !!! I can't figure out how to display T2 images on fsleyes properly ...**

23-02
age 5531days
minQC 0.2553
sub-HM25RQYI4_ses-222549305714procId005496ageDays_run-004_T2w

23-02
age 1406days
minQC 0.3752
sub-HM2VQDK5U_ses-61776394344procId001366ageDays_run-003_T1w


##Looking at Individual Scans
Look at scans for low Ss QC AND for low raw image grade manual rating.
``` {r}
borderline_autoQC <- filter(GA_data, minQC < 0.65 & minQC >= 0.55)
df <- merge(GA_data, qc_manual,by = c("subject_id", "session_id"))
mismatch_QC_mnPS <- filter(df, rawdata_image_grade >= 1 & minQC < 0.65)
mismatch_QC_ssPS <- filter(df, rawdata_image_grade < 1 & minQC >= 0.65)
midlow_autoQC <- filter(GA_data, minQC < 0.4 & minQC > 0.2)
set.seed(42)
s1 <- borderline_autoQC[sample(nrow(borderline_autoQC), 1, replace = FALSE), ]
s2 <-mismatch_QC_mnPS[sample(nrow(mismatch_QC_mnPS), 1, replace = FALSE), ]
s3 <-mismatch_QC_ssPS[sample(nrow(mismatch_QC_ssPS), 1, replace = FALSE), ]
s4 <-midlow_autoQC[sample(nrow(midlow_autoQC), 1, replace = FALSE), ]
full_data[which(full_data$minQC == max(full_data$minQC)),]
full_data[which(full_data$minQC > 0.75 & full_data$adjusted_age_in_days < 1500),]
s4
``` 

##Phenotypes ~ Scan
Take the median of all scans within a type that pass QC. Plot that. Also plot across ages (I think). Plot the median across ages too?
Also plot growth charts based on them?
Phenotypes to use:
WM
CSF
GM - Q: is it for cortical or subcortical?
###Medians by scan type
boxplot with notch, notches extend to  1.58 * IQR / sqrt(n), roughly 95% CI to compare medians
```{r}
df <- full_data %>% filter(minQC >= 0.65)

#group_median(df, scan_type, TCV) #!! This fct currently not working sadly... Might circle back & fix it later.

TCV <- ggplot(df, aes(x = scan_type, y = TCV)) +
    geom_boxplot(coef = 0, notch = TRUE, outlier.shape = NA,aes(fill = scan_type)) + theme(axis.title.x = element_blank(), legend.position = "none")+  scale_y_continuous(limits = quantile(df$TCV, c(0.25, 0.75)))

Cortex <- ggplot(df, aes(x = scan_type, y = Cortex)) +
    geom_boxplot(coef = 0, notch = TRUE, outlier.shape = NA,aes(fill = scan_type)) + theme(axis.title.x = element_blank(), legend.position = "none")+
  scale_y_continuous(limits = quantile(df$Cortex, c(0.25, 0.75)))

WMV <- ggplot(df, aes(x = scan_type, y = WMV)) +
    geom_boxplot(coef = 0, notch = TRUE, outlier.shape = NA,aes(fill = scan_type)) + theme(axis.title.x = element_blank(), legend.position = "none")+
  scale_y_continuous(limits = quantile(df$WMV, c(0.25, 0.75)))

sGMV <- ggplot(df, aes(x = scan_type, y = sGMV)) +
    geom_boxplot(coef = 0, notch = TRUE, outlier.shape = NA,aes(fill = scan_type)) + theme(axis.title.x = element_blank(), legend.position = "none")+
  scale_y_continuous(limits = quantile(df$sGMV, c(0.25, 0.75)))

CSF <- ggplot(df, aes(x = scan_type, y = csf)) +
    geom_boxplot(coef = 0, notch = TRUE, outlier.shape = NA,aes(fill = scan_type)) + theme(axis.title.x = element_blank(), legend.position = "none")+
  scale_y_continuous(limits = quantile(df$csf, c(0.25, 0.75)))

Ventricles <- ggplot(df, aes(x = scan_type, y = Ventricles)) +
    geom_boxplot(coef = 0, notch = TRUE, outlier.shape = NA,aes(fill = scan_type)) + theme(axis.title.x = element_blank(), legend.position = "none")+
  scale_y_continuous(limits = quantile(df$Ventricles, c(0.25, 0.75)))

Cerebellum <- ggplot(df, aes(x = scan_type, y = CerebellumVolume)) +
    geom_boxplot(coef = 0, notch = TRUE, outlier.shape = NA,aes(fill = scan_type)) + theme(axis.title.x = element_blank(), legend.position = "none")+ labs(y =  "Cerebellum") + scale_y_continuous(limits = quantile(df$CerebellumVolume, c(0.25, 0.75)))

Thalamus <- ggplot(df, aes(x = scan_type, y = right.thalamus+left.thalamus)) +
    geom_boxplot(coef = 0, notch = TRUE, outlier.shape = NA,aes(fill = scan_type)) + theme(axis.title.x = element_blank(), legend.position = "none")+ labs(y =  "Thalami") + scale_y_continuous(limits = quantile((df$right.thalamus + df$left.thalamus), c(0.25, 0.75)))

Hippocampus <- ggplot(df, aes(x = scan_type, y = right.hippocampus+left.hippocampus)) +
    geom_boxplot(coef = 0, notch = TRUE, outlier.shape = NA,aes(fill = scan_type)) + theme(axis.title.x = element_blank(), legend.position = "none")+ labs(y =  "Hippocampi")+ scale_y_continuous(limits = quantile((df$right.hippocampus + df$left.hippocampus), c(0.25, 0.75)))

Amygdala <- ggplot(df, aes(x = scan_type, y = right.amygdala+left.amygdala)) +
    geom_boxplot(coef = 0, notch = TRUE, outlier.shape = NA,aes(fill = scan_type)) + theme(axis.title.x = element_blank(), legend.position = "none")+ labs(y =  "Amygdalae") + scale_y_continuous(limits = quantile((df$right.amygdala + df$left.amygdala), c(0.25, 0.75)))

Putamen <- ggplot(df, aes(x = scan_type, y = right.putamen+left.putamen)) +
    geom_boxplot(coef = 0, notch = TRUE, outlier.shape = NA,aes(fill = scan_type)) + theme(axis.title.x = element_blank(), legend.position = "none")+ labs(y = "Putamina") + scale_y_continuous(limits = quantile((df$right.putamen + df$left.putamen), c(0.25, 0.75)))


grid.arrange(TCV, Cortex, sGMV, WMV, CSF, Ventricles, Cerebellum, Thalamus, ncol = 2)
```
###Growth, just plots
```{r}
df <- full_data %>% filter(minQC > 0.65)

# List of variables to plot
vars_to_plot <- exprs(TCV, Cortex, WMV, sGMV, csf, Ventricles, CerebellumVolume, right.thalamus+left.thalamus, right.hippocampus+left.hippocampus, right.amygdala+left.amygdala,right.putamen+left.putamen)

# Create plots for each variable
plots <- lapply(vars_to_plot, function(var) {
  group_smooth(df, scan_type, !!var, age_at_scan)
})

# Assume plots is a list of ggplot plots
grid.arrange(grobs = plots[1:4], ncol = 2)
grid.arrange(grobs = plots[5:8], ncol = 2)
grid.arrange(grobs = plots[9:11], ncol = 2)

```
###Medians within subject(session)
For the median thing, I meant taking the median within subject of all of the scan types, and using that median value as the thing to growth chart.
For all that have passed QC > 0.65
Would be particularly interested in how the median of “all scan types” compares to “all scan type except for MPR” and how these compare to "just the MPR".
```{r}
#vars for the median dataframe
vars <- c("TCV", "Cortex", "WMV", "sGMV", "csf", "Ventricles", "CerebellumVolume")

# Calculate median values for each session across all scans
median_df_all <- full_data %>% filter(minQC >= 0.65) %>% group_by(session_id) %>% summarise(across(all_of(vars), median)) %>% merge(.,select(full_data, c("subject_id", "sex", "age_at_scan", "adjusted_age_in_days", "gestational_age", "session_id", "logAge")), by = "session_id", all.x = TRUE) %>% distinct(subject_id, .keep_all = T)

# Calculate median values for each session across only MPRs
median_df_MPR <- full_data %>% filter(minQC >= 0.65 & scan_type == "MPR") %>% group_by(session_id) %>% summarise(across(all_of(vars), median)) %>% merge(.,select(full_data, c("subject_id", "sex", "age_at_scan", "adjusted_age_in_days", "gestational_age", "session_id","logAge")), by = "session_id", all.x = TRUE) %>% distinct(subject_id, .keep_all = T)

# Calculate median values for each session across only non-MPRs
median_df_nonMPR <- full_data %>% filter(minQC >= 0.65  & scan_type != "MPR") %>% group_by(session_id) %>% summarise(across(all_of(vars), median)) %>% merge(.,select(full_data, c("subject_id", "sex", "age_at_scan", "adjusted_age_in_days", "gestational_age", "session_id", "logAge")), by = "session_id", all.x = TRUE) %>% distinct(subject_id, .keep_all = T)
```
###Growth charts from medians within subject(session)
 **Should make this stuff into a function**
Models & Centile Scores!
For participants who have MPR and non-MPR scans, get the df (median within subject), and auto-correlate
-Raw
More important
-Centile scores! (how do we get centile score auto-correlation?). Like centile scores of individuals? I am not sure I know exactly how to get that? Look into this 2/23 Friday!
```{r}
# Build the growth chart modelm - ALL SCANS
p <- "TCV" # specify the phenotype
df <- median_df_all %>% filter(logAge <= 3.8 & (gestational_age >= 37 | is.na(gestational_age))) #1594 without filter ... #1340 with the filter
# Build the growth chart model - ALL SCANS
p <- "TCV" # specify the phenotype
median_all_GC <- growthchart_model(p, df = median_df_all)
median_MPR_GC <- growthchart_model(p, df = median_df_MPR)
median_non_GC <- growthchart_model(p, df = median_df_nonMPR)
# Predict the median centile of each model
#medianCentileSs <- predictCentilesForAgeRange(model_median_all, df$logAge, df = median_df_all)

# Calculate the age at peak (median) phenotype value
#ageAtPeakSs <- 10^(sort(df$logAge)[which.max(medianCentileSs)])
```

Plotting! -- Make this into standalone figure function that can be repeated!
```{r}
# Set up a list of tick marks to use on log(post-conception age) x-axes
tickMarks <- c()
for (year in c(0, 1, 2, 5, 10, 20)){ # years
  tickMarks <- append(tickMarks, log(year*365.25 + 280, base=10)) #currently has the standard 280 adjustment, but is this reasonable? Perhaps for the scale yes.
}
tickLabels <- c("Birth", "1", "2", "5", "10", "20")


# Plot the original data and the set of centile curves on a figure
plotSs <- ggplot() +
  #geom_point(aes(x=dfSsterm$logAge, dfSsterm[, p]), alpha=0.5) +
  geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[1]]$median), alpha=0.4) +
  geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[2]]$median), alpha=0.6) +
  geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[3]]$median), alpha=0.8) +
  geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[4]]$median)) +
  geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[5]]$median), alpha=0.8) +
  geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[6]]$median), alpha=0.6) +
  geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[7]]$median), alpha=0.4) +
  scale_x_continuous(breaks=tickMarks, labels=tickLabels, 
                     limits=c(tickMarks[[1]], max(centileCurvesSs[[1]]$logAge))) +
  labs(title=paste0("Sample Growth Chart for ", p)) + 
  xlab("Age at scan (log(years))") +
  ylab(paste0(p, " Centile")) + 
  theme(axis.line = element_line(colour = "black"),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        text = element_text(size = 18))

print(plotSs)

# Plot the original data and the set of centile curves on a figure
plotSs_sex <- ggplot() +
  #geom_point(aes(x=dfSsterm$logAge, dfSsterm[, p]), alpha=0.5) +
  ##male curves
  #geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[1]]$male), alpha=0.4, color = "blue") +
  geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[2]]$male), alpha=0.6, color = "blue") +
  #geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[3]]$male), alpha=0.8, color = "blue") +
  geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[4]]$male), color = "blue") +
  #geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[5]]$male), alpha=0.8, color = "blue") +
  geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[6]]$male), alpha=0.6, color = "blue") +
  #geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[7]]$male), alpha=0.4, color = "blue") +
  ##female curves
  #geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[1]]$female), alpha=0.4, color = "red") +
  geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[2]]$female), alpha=0.6, color = "red") +
 #geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[3]]$female), alpha=0.8, color = "red") +
  geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[4]]$female), color = "red") +
 #geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[5]]$female), alpha=0.8, color = "red") +
  geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[6]]$female), alpha=0.6, color = "red") +
 #geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[7]]$female), alpha=0.4, color = "red") +
  scale_x_continuous(breaks=tickMarks, labels=tickLabels, 
                     limits=c(tickMarks[[1]], max(centileCurvesSs[[1]]$logAge))) +
  labs(title=paste0("Sample Growth Chart for ", p, "By Sex")) + 
  xlab("Age at scan (log(years))") +
  ylab(paste0(p, " Centile")) + 
  theme(axis.line = element_line(colour = "black"),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        text = element_text(size = 18))

print(plotSs_sex)
```
##Get GAdata frames QCd
 2/12 
 - Will use MPR scans with minQC >= 0.6 Ss ! Use this for the merging with LBCC. #336 obs
 - Also >= 1 for rawdata image grade #51 obs
 2/13
 - After mtg with Aaron, decided to use >= 0.65 for now. Will re-assess especially after reading the Ss paper.
**Save these dfs for future access. For both QC types.**
```{r}
df_Ss <- GA_data %>% group_by(scan_type) %>% distinct(subject_id, .keep_all = T) %>% filter(scan_type == "MPR"& minQC >= 0.65)
df_mnSs <- merge(GA_data, qc_manual,by = c("subject_id", "session_id")) %>% group_by(scan_type) %>% distinct(subject_id, .keep_all = T) %>% filter(scan_type == "MPR" & rawdata_image_grade >= 1 & minQC >= 0.65)
table(df_Ss$preterm)
table(df_mnSs$preterm)
write.csv(df_Ss, file = "/Users/ekafadar/Documents/Grad_School/BGDLab/SLIP_data/SLIP_GA_SsQC_65.csv", quote = F, row.names = F)
write.csv(df_mnSs, file = "/Users/ekafadar/Documents/Grad_School/BGDLab/SLIP_data/SLIP_GA_mnSsQC_65.csv", quote = F, row.names = F)
```
 ***
## Growth Charts - Term Born
Here I will fit a growth chart curve for the bins of data with GA.
Going off of Jenna's code.

Get GA data that passes QC standards
sex as factor
logAge, base 10 (post-conception offset of 280 days if post-conception age not available)
Also geom_point layer cannot be computed. Keeps giving error: 
Error in `geom_point()`:
! Problem while computing aesthetics.
ℹ Error occurred in the 1st layer.
Caused by error in `new_tibble()`:
! `names` must not be `NULL`.

###Running the Model
```{r}
df_Ss <- read.csv("/Users/ekafadar/Documents/Grad_School/BGDLab/SLIP_data/SLIP_GA_SsQC_65.csv")

# Build the growth chart model
p <- "TCV" # specify the phenotype
#Data split by preterm
#GA_qc_SS_vpm <- GA_qc_SS %>% filter(preterm == "VPM")
#GA_qc_SS_lpm <- GA_qc_SS %>% filter(preterm == "LPM")
dfSsterm <- df_Ss %>% filter(preterm == "Term") %>% select(c("sex", "logAge", p)) #293
#Sort the df
dfSsterm <- dfSsterm[order(dfSsterm$logAge),]
# No SurfaceHoles in the SynthSeg (SS) model
#The df should have no NAs. So create df for the specific variables needed. Or remove all the variables with NAs.
formulaSs <- as.formula(paste0(p, "~fp(logAge, npoly=3) + sex - 1"))
growthChartModelSs_t <-gamlss(formula = formulaSs,
                            sigma.formula = formulaSs,
                            nu.formula = as.formula(paste0(p, "~1")),
                            family = GG,
                            data = dfSsterm,
                            control = gamlss.control(n.cyc = 200),  # See (2)
                            trace = F)


```

###Predicting Centiles
```{r}
# Predict the median centile of each model
medianCentileSs <- predictCentilesForAgeRange(growthChartModelSs_t, dfSsterm$logAge)

# Calculate the age at peak (median) phenotype value
#ageAtPeakSs <- 10^(sort(dfSsterm$logAge)[which.max(medianCentileSs)])

# Predict a set of centiles for each model
centileCurvesSs <- c()
desiredCentiles <- c(0.05, 0.1, 0.25, 0.5, 0.75, 0.9, 0.95)
for (i in c(1:length(desiredCentiles))){
  centileCurvesSs[[i]] <- predictCentilesForAgeRange(growthChartModelSs, dfSsterm$logAge, 
                                                     cent=desiredCentiles[[i]])}
```

###Plotting the Curves
for term-born >37wks without any change to the model
only using logAge and sex.
```{r}
# Set up a list of tick marks to use on log(post-conception age) x-axes
tickMarks <- c()
for (year in c(0, 1, 2, 5, 10, 20, 25)){ # years
  tickMarks <- append(tickMarks, log(year*365+280, base=10)) #currently has the standard 280 adjustment, but is this reasonable? Perhaps for the scale yes.
}
tickLabels <- c("Birth", "1", "2", "5", "10", "20", "25")


# Plot the original data and the set of centile curves on a figure
plotSs <- ggplot() +
  geom_point(aes(x=centileCurvesSs[[1]]$logAge, dfSsterm[, p]), alpha=0.5) +
  geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[1]]$median), alpha=0.4) +
  geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[2]]$median), alpha=0.6) +
  geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[3]]$median), alpha=0.8) +
  geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[4]]$median)) +
  geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[5]]$median), alpha=0.8) +
  geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[6]]$median), alpha=0.6) +
  geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[7]]$median), alpha=0.4) +
  scale_x_continuous(breaks=tickMarks, labels=tickLabels, 
                     limits=c(tickMarks[[1]], max(centileCurvesSs[[1]]$logAge))) +
  labs(title=paste0("Sample Growth Chart for ", p)) + 
  xlab("Age at scan (log(years))") +
  ylab(paste0(p, " Centile")) + 
  theme(axis.line = element_line(colour = "black"),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        text = element_text(size = 18))

print(plotSs)

# Plot the original data and the set of centile curves on a figure
plotSs_sex <- ggplot() +
  #geom_point(aes(x=dfSsterm$logAge, dfSsterm[, p]), alpha=0.5) +
  ##male curves
  #geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[1]]$male), alpha=0.4, color = "blue") +
  geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[2]]$male), alpha=0.6, color = "blue") +
  #geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[3]]$male), alpha=0.8, color = "blue") +
  geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[4]]$male), color = "blue") +
  #geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[5]]$male), alpha=0.8, color = "blue") +
  geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[6]]$male), alpha=0.6, color = "blue") +
  #geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[7]]$male), alpha=0.4, color = "blue") +
  ##female curves
  #geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[1]]$female), alpha=0.4, color = "red") +
  geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[2]]$female), alpha=0.6, color = "red") +
 #geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[3]]$female), alpha=0.8, color = "red") +
  geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[4]]$female), color = "red") +
 #geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[5]]$female), alpha=0.8, color = "red") +
  geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[6]]$female), alpha=0.6, color = "red") +
 #geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[7]]$female), alpha=0.4, color = "red") +
  scale_x_continuous(breaks=tickMarks, labels=tickLabels, 
                     limits=c(tickMarks[[1]], max(centileCurvesSs[[1]]$logAge))) +
  labs(title=paste0("Sample Growth Chart for ", p, "By Sex")) + 
  xlab("Age at scan (log(years))") +
  ylab(paste0(p, " Centile")) + 
  theme(axis.line = element_line(colour = "black"),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        text = element_text(size = 18))

print(plotSs_sex)
```
## Growth Charts - NON Term Born
Warning: Algorithm RS has not yet converged
43 obs - very small sample size I think ...
###Running the Model
```{r}
df_Ss <- GA_data %>% group_by(scan_type) %>% distinct(subject_id, .keep_all = T) %>% filter(scan_type == "MPR"& minQC >= 0.6)
df_mnSs <- merge(GA_data, qc_manual,by = c("subject_id", "session_id")) %>% group_by(scan_type) %>% distinct(subject_id, .keep_all = T) %>% filter(scan_type == "MPR" & rawdata_image_grade >= 1 & minQC >= 0.6)

# Build the growth chart model
p <- "TCV" # specify the phenotype
#Data split by preterm
#GA_qc_SS_vpm <- GA_qc_SS %>% filter(preterm == "VPM")
#GA_qc_SS_lpm <- GA_qc_SS %>% filter(preterm == "LPM")
dfSsNonterm <- df_Ss %>% filter(preterm != "Term") %>% select(c("sex", "logAge", "TCV")) #293
#Sort the df
dfSsNonterm <- dfSsNonterm[order(dfSsNonterm$logAge),]
# No SurfaceHoles in the SynthSeg (SS) model
#The df should have no NAs. So create df for the specific variables needed. Or remove all the variables with NAs.
formulaSs <- as.formula(paste0(p, "~fp(logAge, npoly=3) + sex - 1"))
growthChartModelSs <-gamlss(formula = formulaSs,
                            sigma.formula = formulaSs,
                            nu.formula = as.formula(paste0(p, "~1")),
                            family = GG,
                            data = dfSsNonterm,
                            control = gamlss.control(n.cyc = 500),  # See (2)
                            trace = F)


```

###Predicting Centiles
```{r}
# Predict the median centile of each model
medianCentileSs <- predictCentilesForAgeRange(growthChartModelSs, dfSsNonterm$logAge)

# Calculate the age at peak (median) phenotype value
ageAtPeakSs <- 10^(sort(dfSsNonterm$logAge)[which.max(medianCentileSs)])

# Predict a set of centiles for each model
centileCurvesSs <- c()
desiredCentiles <- c(0.05, 0.1, 0.25, 0.5, 0.75, 0.9, 0.95)
for (i in c(1:length(desiredCentiles))){
  centileCurvesSs[[i]] <- predictCentilesForAgeRange(growthChartModelSs, dfSsNonterm$logAge, 
                                                     cent=desiredCentiles[[i]])}
```

###Plotting the Curves
for term-born >37wks without any change to the model
only using logAge and sex.
```{r}
# Set up a list of tick marks to use on log(post-conception age) x-axes
tickMarks <- c()
for (year in c(0, 1, 2, 5, 10, 20)){ # years
  tickMarks <- append(tickMarks, log(year*365.25 + 280, base=10)) #currently has the standard 280 adjustment, but is this reasonable? Perhaps for the scale yes.
}
tickLabels <- c("Birth", "1", "2", "5", "10", "20")


# Plot the original data and the set of centile curves on a figure
plotSs <- ggplot() +
  #geom_point(aes(x=dfSsNonterm$logAge, dfSsNonterm[, p]), alpha=0.5) +
  geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[1]]$median), alpha=0.4) +
  geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[2]]$median), alpha=0.6) +
  geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[3]]$median), alpha=0.8) +
  geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[4]]$median)) +
  geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[5]]$median), alpha=0.8) +
  geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[6]]$median), alpha=0.6) +
  geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[7]]$median), alpha=0.4) +
  scale_x_continuous(breaks=tickMarks, labels=tickLabels, 
                     limits=c(tickMarks[[1]], max(centileCurvesSs[[1]]$logAge))) +
  xlab("Age at scan (log(years))") +
  ylab(paste0(p, " Centile")) + 
  theme(axis.line = element_line(colour = "black"),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        text = element_text(size = 18))

print(plotSs)

# Plot the original data and the set of centile curves on a figure
plotSs_sex <- ggplot() +
  #geom_point(aes(x=dfSsNonterm$logAge, dfSsNonterm[, p]), alpha=0.5) +
  ##male curves
  #geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[1]]$male), alpha=0.4, color = "blue") +
  geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[2]]$male), alpha=0.6, color = "blue") +
  #geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[3]]$male), alpha=0.8, color = "blue") +
  geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[4]]$male), color = "blue") +
  #geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[5]]$male), alpha=0.8, color = "blue") +
  geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[6]]$male), alpha=0.6, color = "blue") +
  #geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[7]]$male), alpha=0.4, color = "blue") +
  ##female curves
  #geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[1]]$female), alpha=0.4, color = "red") +
  geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[2]]$female), alpha=0.6, color = "red") +
 #geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[3]]$female), alpha=0.8, color = "red") +
  geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[4]]$female), color = "red") +
 #geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[5]]$female), alpha=0.8, color = "red") +
  geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[6]]$female), alpha=0.6, color = "red") +
 #geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[7]]$female), alpha=0.4, color = "red") +
  scale_x_continuous(breaks=tickMarks, labels=tickLabels, 
                     limits=c(tickMarks[[1]], max(centileCurvesSs[[1]]$logAge))) +
  labs(title=paste0("Sample Growth Chart for ", p, "By Sex")) + 
  xlab("Age at scan (log(years))") +
  ylab(paste0(p, " Centile")) + 
  theme(axis.line = element_line(colour = "black"),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        text = element_text(size = 18))

print(plotSs_sex)
```

try to run gamlss only within 'not-term' born ones. Very small sample size ... not sure how this will turn out.



###more figures not yet attempted
```{r}
# Calculate the closest centile to each subject's phenotype value
phenoCentilesSs <- calculatePhenotypeCentile(growthChartModelSs, dfSSterm[[p]], dfSSterm$logAge, dfSSterm$sex)
regionsSs <- rep(p, length(phenoCentilesSs))
idxesSs <- c(1:length(phenoCentilesSs))

# Plot the centiles of the phenotypes in a violin plot
dfSsViolin <- data.frame(idxesSs, regionsSs, phenoCentilesSs)
plotPhenoCentSs <- ggplot(data=dfSsViolin, aes(regionsSs, phenoCentilesSs)) +
  geom_violin(color="gray", fill="gray", alpha=0.35) +
  geom_jitter(height = 0, width=0.15, alpha=0.65) +
  labs(title=paste0("Centiles (Phenotype = ", p,")")) +
  xlab("SynthSeg") +
  ylab("Centile Value") +
  theme(axis.line = element_line(colour = "black"),
        # panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        text = element_text(size = 18))

print(plotPhenoCentSs)
plot(dfSSterm$logAge, dfSSterm$TCV)
```
#Play - LBCC
Got LBCC data from Lena
dHCP fetal
dHCP neonatal (25-40wk) 25% premature, many with term equivalent scan
CHILD fetal + neonatal (30-35wk fetal, no gestational age at birth info)
Harvard fetal (gestational age at scan 19-38)
BCP (adjusted age, all term born)
PING (30-43wk) 3-21 age
Conte (27-42wk) 6 timepoints
NIH (30-43wk) 5-25 age
PNC (~250 have GA/BW, 25-42wk) 8-21 age
TEBC (22-42wk) neonates
ABCD (10k)
FinnBrain
UKB (1200k)
SLIP
##Load Data
! File saved at the end is not filtered out for only "unique" IDs ie one scan per participant.
```{r}
lbcc <- load_data(names = "lbcc", lbcc_ga_file) %>% bind_rows(.) %>%  select(-1, -2) #drop first two columns, repeat of row numbers
length(unique(lbcc$participant))#15779 unique participant IDs

#fix some columns in lbcc
lbcc <- lbcc %>% rename(hippocampi_and_amygdalae = hippocampi_and_amygdale) %>% mutate(PC_days_at_scan = PCW_at_scan*7, PCW_at_birth_recoded = as.integer(PCW_at_birth_recoded))
#fix column names to match lbcc dataframe
slip_GASsQc <- read.csv("/Users/ekafadar/Documents/Grad_School/BGDLab/SLIP_data/SLIP_GA_SsQC_65.csv")
slip_GASsQc <- slip_GASsQc %>% mutate(total_GM = Cortex + sGMV, total_GMWM = Cortex + sGMV + WMV, cort_WM = right.cerebral.white.matter + left.cerebral.white.matter, thalamus = right.thalamus + left.thalamus, hippocampus = right.hippocampus+left.hippocampus, putamen = right.putamen + left.putamen, hippocampi_and_amygdalae = right.hippocampus + left.hippocampus + right.amygdala + left.amygdala) %>% rename(participant = subject_id, PCW_at_birth_recoded = gestational_age, study = study_id, CSF = csf, ventricles = Ventricles, total_WM = WMV, brainMaskVol = TCV, cort_GM = Cortex, subc_GM = sGMV, cerebellum = CerebellumVolume, GAbins = preterm, PC_days_at_scan = adjusted_age_in_days)

```
Duplicate IDs problem
```{r}
test_lbcc <- lbcc[duplicated(lbcc$participant),] #3216
table(test_lbcc$study)
test_lbcc$IDStudy <- paste0(test_lbcc$participant, test_lbcc$study)
sum(duplicated(test_lbcc$IDStudy))

test <- lbcc_slip[duplicated(lbcc_slip$participant),] #3453
table(test$study) #lots of slip rows in the "duplicated IDs" table
test_slip <- slip_GASsQc[duplicated(slip_GASsQc$participant),] #no duplicated within the slip dataset

```


Combine lbcc and slip dataframes
```{r}
#bind dfs
lbcc_slip <- bind_rows(lbcc, slip_GASsQc)
write.csv(lbcc_slip, file = "/Users/ekafadar/Documents/Grad_School/BGDLab/SLIP_data/lbcc_slip_GA_combo.csv", quote = F, row.names = F)
```
##Inspect Data Distribution
~10K from ABCD (over 50% of data points)
Harvard fetal and dHCP data - aren't born yet lol.
DCHS study might not be appropriate, it is a dataset of southafrican moms & babies. Delete it!
CONTE & CHILD & TEBC do not have regional info (but might have for subcortical volumes)
!!Add the SLIP scans to this dataset.
```{r}
table(lbcc$study)
sum(!is.na(lbcc$PCW_at_birth)) #18392
sum(!is.na(lbcc$PCW_at_birth_recoded))#18392
range(na.omit(lbcc$PCW_at_birth))#[2 50]
boxplot(lbcc$PCW_at_birth)
boxplot(lbcc$PCW_at_scan)
hist(lbcc$PCW_at_scan)

#Preterm categories (broad)
# Create a new column indicating cut points: specifying by weeks.
lbcc$preterm <- cut(lbcc$PCW_at_birth, breaks = c(-Inf, 31.9, 36.9, Inf), labels = c("VPM", "LPM", "Term"), include.lowest = TRUE)
table(lbcc$preterm)
table(lbcc[match(unique(lbcc$participant), lbcc$participant),"preterm"])
table(lbcc[match(unique(lbcc_slip$participant), lbcc$participant),"GAbins"])
```

For lbcc-slip combo
!! idk why recoding the factor level names is not working :(
```{r}
table(lbcc_slip$study)
table(subset(lbcc_slip, !is.na(PCW_at_birth_recoded))$study)
sum(!is.na(lbcc_slip$PCW_at_birth)) #18392
sum(!is.na(lbcc_slip$PCW_at_birth_recoded)) #18652
sum(!is.na(lbcc_slip$PC_days_at_scan)) #19255
range(na.omit(lbcc_slip$PCW_at_birth))#[2 50]
range(na.omit(lbcc_slip$PCW_at_birth_recoded))#[2 50]
boxplot(lbcc_slip$PCW_at_birth_recoded, ylab = "PCW at birth")
boxplot(lbcc_slip$PC_days_at_scan, ylab = "PC Days at scan")
hist(lbcc_slip$PCW_at_birth)
hist(lbcc_slip$PC_days_at_scan)
```

```{r}
#Preterm categories (broad)
# Create a new column indicating cut points: specifying by weeks.
lbcc_slip <- read.csv("/Users/ekafadar/Documents/Grad_School/BGDLab/SLIP_data/lbcc_slip_GA_combo.csv")
lbcc_slip$preterm <- cut(lbcc_slip$PCW_at_birth, breaks = c(-Inf, 31.9, 36.9, Inf), labels = c("VPM", "LPM", "Term"), include.lowest = TRUE)
lbcc_slip$GAbins_recode <- as.character(lbcc_slip$preterm)
lbcc_slip$GAbins_recode[lbcc_slip$GAbins == "fetal"] <- "fetal"
lbcc_slip$GAbins_recode <- as.factor(lbcc_slip$GAbins_recode)
lbcc_slip$sex <- as.factor(lbcc_slip$sex)
table(lbcc_slip$GAbins_recode)
table(lbcc_slip[match(unique(lbcc_slip$participant), lbcc_slip$participant),"preterm"])
table(lbcc_slip[match(unique(lbcc_slip$participant), lbcc_slip$participant),"GAbins_recode"])

#Get LogAge
lbcc_slip$logAgePCDays <- log10(lbcc_slip$PC_days_at_scan) 

```
##Plotting the raw data
###All data
```{r}
# List of variables to plot
vars_to_plot <- exprs(total_GM, CSF, ventricles, subc_GM, brainMaskVol, cerebellum, thalamus, weight_at_scan)
df <- lbcc_slip[match(unique(lbcc_slip$participant), lbcc_slip$participant),] %>% filter(!is.na(GAbins_recode) & (PC_days_at_scan/365) <= 25 & GAbins_recode != "fetal")
# Create plots for each variable
plots <- lapply(vars_to_plot, function(var) {
  group_smooth(df, GAbins_recode, !!var, log10(PC_days_at_scan))
})

# Assume plots is a list of ggplot plots
grid.arrange(grobs = plots[1:4], ncol = 2)
grid.arrange(grobs = plots[5:8], ncol = 2)

hist(df$PC_days_at_scan)
```
###Age Constrained
```{r}
# List of variables to plot
vars_to_plot <- exprs(total_GM, CSF, ventricles, subc_GM, brainMaskVol, cerebellum, thalamus, weight_at_scan)
df <- lbcc_slip %>% filter(!is.na(GAbins_recode) & (PC_days_at_scan/365) <= 2 & GAbins_recode != "fetal") %>% distinct(participant, .keep_all = T)
test <- lbcc_slip %>% filter(!is.na(GAbins_recode) & GAbins_recode != "fetal") %>% distinct(participant, .keep_all = T)
# Create plots for each variable
plots <- lapply(vars_to_plot, function(var) {
  group_smooth(df, GAbins_recode, !!var, log10(PC_days_at_scan))
})

# Assume plots is a list of ggplot plots
grid.arrange(grobs = plots[1:4], ncol = 2) 
grid.arrange(grobs = plots[5:8], ncol = 2)
```

##Growth Charts


###Running the Model
!! **I am not so sure about how I adjusted the formula to include GAbins as a variable. I don't know whether I should have included a different offset (or what the original -1 was even for .....)**
```{r}
# Build the growth chart model
p <- "brainMaskVol" # specify the phenotype
#Get the correct df
df <- lbcc_slip[match(unique(lbcc_slip$participant), lbcc_slip$participant),] %>% filter(!is.na(GAbins_recode) & GAbins_recode != "fetal") %>% select("logAgePCDays", "sex", p , GAbins_recode)
#Sort the df
df <- df[order(df$logAgePCDays),] %>% na.omit()
# No SurfaceHoles in the SynthSeg (SS) model
#The df should have no NAs. So create df for the specific variables needed. Or remove all the variables with NAs.
source("~/Documents/Grad_School/BGDLab/GestationalAge/R/scripts/centiles_draft.R")
formulaSs_GA <- as.formula(paste0(p, "~fp(logAgePCDays, npoly=3) + GAbins_recode + sex - 1"))
growthChartModelSs_GA <-gamlss(formula = formulaSs_GA,
                            sigma.formula = formulaSs_GA,
                            nu.formula = as.formula(paste0(p, "~1")),
                            family = GG,
                            data = df,
                            control = gamlss.control(n.cyc = 200),  # See (2)
                            trace = F)

formulaSs <- as.formula(paste0(p, "~fp(logAgePCDays, npoly=3) + sex - 1"))
growthChartModelSs <-gamlss(formula = formulaSs,
                            sigma.formula = formulaSs,
                            nu.formula = as.formula(paste0(p, "~1")),
                            family = GG,
                            data = df,
                            control = gamlss.control(n.cyc = 200),  # See (2)
                            trace = F)



```

###Predicting Centiles
```{r}
# Predict the median centile of each model
medianCentileSs <- predictCentilesForAgeRange_GAbins(growthChartModelSs_GA, df$logAgePCDays)
medianCentileSs <- predictCentilesForAgeRange(growthChartModelSs_GA, df$logAgePCDays)


medianCentileSs <- predictCentilesForAgeRange(growthChartModelSs, df$logAgePCDays)

```

```{r}
# Calculate the age at peak (median) phenotype value
ageAtPeakSs <- 10^(sort(dfSsterm$logAge)[which.max(medianCentileSs)])

# Predict a set of centiles for each model
centileCurvesSs <- c()
desiredCentiles <- c(0.05, 0.1, 0.25, 0.5, 0.75, 0.9, 0.95)
for (i in c(1:length(desiredCentiles))){
  centileCurvesSs[[i]] <- predictCentilesForAgeRange_GAbins(growthChartModelSs, df$logAgePCDays, 
                                                     cent=desiredCentiles[[i]])}
```

###Plotting the Curves
for term-born >37wks without any change to the model
only using logAge and sex.
```{r}
# Set up a list of tick marks to use on log(post-conception age) x-axes
tickMarks <- c()
for (year in c(0, 1, 2, 5, 10, 20)){ # years
  tickMarks <- append(tickMarks, log(year*365.25 + 280, base=10)) #currently has the standard 280 adjustment, but is this reasonable? Perhaps for the scale yes.
}
tickLabels <- c("Birth", "1", "2", "5", "10", "20")


# Plot the original data and the set of centile curves on a figure
plotSs <- ggplot() +
  #geom_point(aes(x=dfSsterm$logAge, dfSsterm[, p]), alpha=0.5) +
  geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[1]]$median), alpha=0.4) +
  geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[2]]$median), alpha=0.6) +
  geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[3]]$median), alpha=0.8) +
  geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[4]]$median)) +
  geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[5]]$median), alpha=0.8) +
  geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[6]]$median), alpha=0.6) +
  geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[7]]$median), alpha=0.4) +
  scale_x_continuous(breaks=tickMarks, labels=tickLabels, 
                     limits=c(tickMarks[[1]], max(centileCurvesSs[[1]]$logAge))) +
  labs(title=paste0("Sample Growth Chart for ", p)) + 
  xlab("Age at scan (log(years))") +
  ylab(paste0(p, " Centile")) + 
  theme(axis.line = element_line(colour = "black"),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        text = element_text(size = 18))

print(plotSs)

# Plot the original data and the set of centile curves on a figure
plotSs_sex <- ggplot() +
  #geom_point(aes(x=dfSsterm$logAge, dfSsterm[, p]), alpha=0.5) +
  ##male curves
  #geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[1]]$male), alpha=0.4, color = "blue") +
  geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[2]]$male), alpha=0.6, color = "blue") +
  #geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[3]]$male), alpha=0.8, color = "blue") +
  geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[4]]$male), color = "blue") +
  #geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[5]]$male), alpha=0.8, color = "blue") +
  geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[6]]$male), alpha=0.6, color = "blue") +
  #geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[7]]$male), alpha=0.4, color = "blue") +
  ##female curves
  #geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[1]]$female), alpha=0.4, color = "red") +
  geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[2]]$female), alpha=0.6, color = "red") +
 #geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[3]]$female), alpha=0.8, color = "red") +
  geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[4]]$female), color = "red") +
 #geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[5]]$female), alpha=0.8, color = "red") +
  geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[6]]$female), alpha=0.6, color = "red") +
 #geom_line(aes(x=centileCurvesSs[[1]]$logAge, y=centileCurvesSs[[7]]$female), alpha=0.4, color = "red") +
  scale_x_continuous(breaks=tickMarks, labels=tickLabels, 
                     limits=c(tickMarks[[1]], max(centileCurvesSs[[1]]$logAge))) +
  labs(title=paste0("Sample Growth Chart for ", p, "By Sex")) + 
  xlab("Age at scan (log(years))") +
  ylab(paste0(p, " Centile")) + 
  theme(axis.line = element_line(colour = "black"),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        text = element_text(size = 18))

print(plotSs_sex)
```