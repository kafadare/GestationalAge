---
title: "0319_035"
author: "Eren Kafadar"
date: "2024-03-19"
output: html_document
editor_options: 
  chunk_output_type: inline
---
# Thoughts on this week
Study as random effect -- still working on this, not much progress made last week unfortunately
- per Margaret could predict based on the most common study, and then regress out the fx of study later. use re() instead of random() to get the study effects extractable.
  - Still don't fully understand how random fx work, should watch some videos + the book chapter
- Also check if the predict function has built-in functionality to "ignore" the random effects (Lena mentioned it might)

Once study random fx is sorted (hopefully!)
- GA x age interaction model test

In slip: repeat GA modeling analysis combining VPM & LPM

For ABCD -- First goal is to download all the required files locally (as explained by Lena the aseg files include the MRI data I want).
- Start with global tissue segmentations
  - linear modeling of the growth (two data points)
  - gamlss modeling of the three data points
  - do these using the "term" OR 40wk only subjects -- could look at both
  - get "centile" scores or "z-scores" (for linear model) for the "preterm born" kids
    - Are there groups: look at data distribution of these deviation scores
- Can repeat for many phenotypes, start with regional volumes
  - Look at literature to avoid non-thoughtful multiple comparisons-type error
  - Some specific regions/tissue types that may be delayed/different
  
-For trajectory differences ... further down the line.
  - Would want to model longitudinally including GA and GAxage as a predictor term.

 **To fix inside functions**
- for output of predictCentiles: only one logAge column.
- fix ageAtPeaks code so that it works with the the predictCentiles output.
- Change function names for different analysis types.
- Consider changing workflow to specify different datasets better: perhaps include separate setup with loading functions for each section?

Also Still Need To:
-Read Ss paper!!
-Look at fsleyes segmentations of VERY BAD segmentations (infants) with low autoQC scores
-Read nature braincharts paper supplemental methods

***

This is the script from Jenna's github that would be a helpful place to start to build gamlss models. There should also be Jakob's scripts that are more complicated but provide more flexibility (this is my understanding) in choosing a model.
https://github.com/jmschabdach/mpr_analysis/blob/develop/r/build_your_own_growth_chart.R

Notes on Jenna Code
- FreeSurfer model includes SurfaceHoles variable in model, not applicable in SynthSeg output.
- logAge: numeric type with log(post conception age in days, base=10). In (1), we use a conversion factor of 325.25 days/year and a post conception offset of 280 days if post conception age is not available.

***

***

#Setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(magrittr)
library(table1)
library(ggplot2)
library(rlang)
library(viridis)
library(gridExtra)
library(purrr)
library(cowplot)
library(gamlss) #to fit model
library(mgcv) # helps with the gam models
library(tidymv) # helps with the gam models

#setwd("/Users/ekafadar/Documents/Grad_School/BGDLab/GestationalAge/")
source("/Users/ekafadar/Documents/Grad_School/BGDLab/GestationalAge/R/scripts/data_functions.R")
source("~/Documents/Grad_School/BGDLab/GestationalAge/R/scripts/lib_mpr_analysis_EK.r")
source("~/Documents/Grad_School/BGDLab/GestationalAge/R/scripts/growth_chart_fcts_EK.r")
source("~/Documents/Grad_School/BGDLab/GestationalAge/R/scripts/figures.r")
source("~/Documents/Grad_School/BGDLab/GestationalAge/R/scripts/GAmodeling_draft.r")
source("~/Documents/Grad_School/BGDLab/GestationalAge/R/scripts/centile_functions_ABCD.r")

folders <- c("/Users/ekafadar/Documents/Grad_School/BGDLab/SLIP_data/2024-01-19_release/slip_2022/","/Users/ekafadar/Documents/Grad_School/BGDLab/SLIP_data/2024-01-19_release/slip_2023_02/", "/Users/ekafadar/Documents/Grad_School/BGDLab/SLIP_data/2024-01-19_release/slip_2023_03/")
manual_qc_file <- "/Users/ekafadar/Documents/Grad_School/BGDLab/SLIP_data/manual_qc_grades_radiology_paper.csv"
lbcc_ga_file <- "~/Documents/Grad_School/BGDLab/LBCC_data/GA.all.data-24-02.csv"
abcd_vol_aseg_file <- "~/Documents/Grad_School/BGDLab/ABCD_data/mri_y_smr_vol_aseg.csv"
abcd_demo_file <- "~/Documents/Grad_School/BGDLab/ABCD_data/abcd_p_demo.csv"
abcd_medhx_file <- "~/Documents/Grad_School/BGDLab/ABCD_data/ph_p_dhx.csv"
abcd_mri_adm_file <- "~/Documents/Grad_School/BGDLab/ABCD_data/mri_y_adm_info.csv"
abcd_ltrack_file <- "~/Documents/Grad_School/BGDLab/ABCD_data/abcd_y_lt.csv"
abcd_screen_file <- "~/Documents/Grad_School/BGDLab/ABCD_data/abcd_p_screen.csv"
```

# Play - SLIP
## Load Data
Data Jenna sent is in 3 folders by release date
There are 3 files in each folder
- qc scores csv % synthseg volumes csv -- 2155 unique subject_ids, and 11267 unique data points (subject + age at scan?)
- participants tsv -- 2173 total data

Put all the data together from three releases and merge the qc scores, volumes, and participant data
Save this full dataset
###Load all csv data and merge
```{r}
participants <- load_data(names = c(paste0("data",1:3)), paste0(folders,"participants.tsv")) %>% bind_rows(.)
qc_scores <- load_data(names = c(paste0("data",1:3)), paste0(folders,"synthseg+_qc_scores.csv")) %>% bind_rows(.)
volumes <- load_data(names = c(paste0("data",1:3)), paste0(folders,"synthseg+_volumes.csv")) %>% bind_rows(.)
colnames(qc_scores) <- c(paste0(names(qc_scores[1:8])),paste0(names(qc_scores[9:length(names(qc_scores))]),"_qc"))
qc_manual <- load_data(names = "qc", manual_qc_file) %>% bind_rows(.)
qc_manual$full_path <- qc_manual$scan_id
qc_manual$scan_id <- gsub("(?:.*/){10}", "\\1", qc_manual$full_path) %>% sub("\\.nii\\.gz$", "", .)
#merge
full_data <- merge(qc_scores, volumes, by = intersect(names(qc_scores), names(volumes)))
full_data <- merge(full_data, participants, by = intersect(names(full_data), names(participants)))
write.csv(full_data, file = "/Users/ekafadar/Documents/Grad_School/BGDLab/SLIP_data/SLIP_combined_011923.csv", quote = F, row.names = F)
```

###Load full data
adjust variables: log10 age, get minQC column
2/12 Fix adjusted age. Original df was adding GA in weeks to age at scan in days.
Now we are
adding GA x 7 + age at scan
if GA not available, then adding 280 + age at scan (for assuming a 40week term pregnancy) -- just so there is no NAs in the column, but in actuality we don't know if these scans were full-term or not.
```{r}
qc_manual <- load_data(names = "qc", manual_qc_file) %>% bind_rows(.)
qc_manual$full_path <- qc_manual$scan_id
qc_manual$scan_id <- gsub("(?:.*/){10}", "\\1", qc_manual$full_path) %>% sub("\\.nii\\.gz$", "", .)
full_data <- read.csv("/Users/ekafadar/Documents/Grad_School/BGDLab/SLIP_data/SLIP_combined_011923.csv") 
full_data <- full_data %>% mutate(sex = as.factor(sex)) %>% rowwise() %>% 
  mutate(minQC = min(c_across(contains("qc"))))
full_data$adjusted_age_in_days <- ifelse(!is.na(full_data$gestational_age), (full_data$age_at_scan + (full_data$gestational_age*7)), full_data$age_at_scan + 280)
levels(full_data$sex) <- c("F", "M") #male = 0, female = 1
full_data$logAge <- log10(full_data$adjusted_age_in_days)
```

###Split data by scan type, ageBin
```{r}
full_data$scan_type <- as.factor(ifelse(grepl("MPR", full_data$scan_id), "MPR", ifelse((!grepl("MPR", full_data$scan_id) & grepl("T1w", full_data$scan_id)), "T1w_other", ifelse(grepl("T2w", full_data$scan_id), "T2w", ifelse(grepl("FLAIR", full_data$scan_id), "flair", NA)))))
full_data$ageBin <- cut(full_data$age_at_scan, breaks = c(-Inf, 30, 365, 1095, 2190, 4380, Inf), labels = c("Newborn", "Infant", "Toddler", "Preschool", "School_Age", "Adolescent"), include.lowest = TRUE)
#df_MPR <- full_data[grepl("MPR", full_data$scan_id),] %>% distinct(subject_id, .keep_all = T)#947

#df_T1w <- full_data[!grepl("MPR", full_data$scan_id) & grepl("T1w", full_data$scan_id),] %>% distinct(subject_id, .keep_all = T)#1743

#df_T2w <- full_data[grepl("T2w", full_data$scan_id),] %>% distinct(subject_id, .keep_all = T)#1021

#table(grepl("FLAIR",full_data$scan_id))#891
table(full_data$scan_type)
```
1229 MPR scans, 947 unique subject ids
6519 T1w non-MPR scans, 1743 unique subject ids
2628 T2w scans, 1021 unique subject ids
891 FLAIR scans
-All 11267 scans accounted for above.

###Separate df w/ GA
Use scans with MPR. df_MPR
!!! Noticed on 2/6/24 that the cut-offs were inclusive, so changed them to 31.9 and 36.9, this will change the #s of subjects for the categories down the line. So should re-run things!!
```{r}
all_GA_data <- subset(full_data, !is.na(gestational_age))#358
GA_data <- subset(filter(full_data, scan_type == "MPR"), !is.na(gestational_age)) %>% distinct(subject_id, .keep_all = T)#358
GA_data$log_GA <- log10(GA_data$gestational_age)
#Split in GA bins
# Determine the cut points based on quantiles
cut_points <- quantile(GA_data$gestational_age, probs = c(1/3, 2/3)) # cut points are 39 and 40. So this will NOT work.

cut_points <- quantile(GA_data$log_GA, probs = c(1/3, 2/3)) # cut points are 1.59 and 1.6. So this will NOT work.

# Create a new column indicating cut points: specifying by weeks.
GA_data$preterm <- cut(GA_data$gestational_age, breaks = c(-Inf, 31.9, 36.9, Inf), labels = c("VPM", "LPM", "Term"), include.lowest = TRUE)
table(GA_data$preterm)
table(GA_data$sex)
table(all_GA_data$scan_type)
```
##Looking at Individual Scans
Look at scans for low Ss QC AND for low raw image grade manual rating.
``` {r}
borderline_autoQC <- filter(GA_data, minQC < 0.65 & minQC >= 0.55)
df <- merge(GA_data, qc_manual,by = c("subject_id", "session_id"))
mismatch_QC_mnPS <- filter(df, rawdata_image_grade >= 1 & minQC < 0.65)
mismatch_QC_ssPS <- filter(df, rawdata_image_grade < 1 & minQC >= 0.65)
midlow_autoQC <- filter(GA_data, minQC < 0.4 & minQC > 0.2)
set.seed(42)
s1 <- borderline_autoQC[sample(nrow(borderline_autoQC), 1, replace = FALSE), ]
s2 <-mismatch_QC_mnPS[sample(nrow(mismatch_QC_mnPS), 1, replace = FALSE), ]
s3 <-mismatch_QC_ssPS[sample(nrow(mismatch_QC_ssPS), 1, replace = FALSE), ]
s4 <-midlow_autoQC[sample(nrow(midlow_autoQC), 1, replace = FALSE), ]
full_data[which(full_data$minQC == max(full_data$minQC)),]
full_data[which(full_data$minQC > 0.75 & full_data$adjusted_age_in_days < 1500),]
s4
``` 

##Get GAdata frames QCd
 2/12 
 - Will use MPR scans with minQC >= 0.6 Ss ! Use this for the merging with LBCC. #336 obs
 - Also >= 1 for rawdata image grade #51 obs
 2/13
 - After mtg with Aaron, decided to use >= 0.65 for now. Will re-assess especially after reading the Ss paper.
**Save these dfs for future access. For both QC types.**
```{r}
df_Ss <- GA_data %>% group_by(scan_type) %>% distinct(subject_id, .keep_all = T) %>% filter(scan_type == "MPR"& minQC >= 0.65)
df_mnSs <- merge(GA_data, qc_manual,by = c("subject_id", "session_id")) %>% group_by(scan_type) %>% distinct(subject_id, .keep_all = T) %>% filter(scan_type == "MPR" & rawdata_image_grade >= 1 & minQC >= 0.65)
table(df_Ss$preterm)
table(df_mnSs$preterm)
write.csv(df_Ss, file = "/Users/ekafadar/Documents/Grad_School/BGDLab/SLIP_data/SLIP_GA_SsQC_65.csv", quote = F, row.names = F)
write.csv(df_mnSs, file = "/Users/ekafadar/Documents/Grad_School/BGDLab/SLIP_data/SLIP_GA_mnSsQC_65.csv", quote = F, row.names = F)
```
 ***
## Growth Charts
Here I will fit a growth chart curve for the bins of data with GA.
Going off of Jenna's code.

Get GA data that passes QC standards
sex as factor
logAge, base 10 (post-conception offset of 280 days if post-conception age not available)
Also geom_point layer cannot be computed. Keeps giving error: 
Error in `geom_point()`:
! Problem while computing aesthetics.
â„¹ Error occurred in the 1st layer.
Caused by error in `new_tibble()`:
! `names` must not be `NULL`.

###Running the Model
**Combine the VPM & LPM
```{r}
df <- read.csv("/Users/ekafadar/Documents/Grad_School/BGDLab/SLIP_data/SLIP_GA_SsQC_65.csv") %>% arrange(logAge) %>% rename(GAbins_recode = preterm) %>% arrange(logAge)
df <- read.csv("/Users/ekafadar/Documents/Grad_School/BGDLab/SLIP_data/SLIP_GA_SsQC_65.csv") %>% arrange(logAge) %>% rename(GAbins_recode = preterm) %>% mutate(logAge_unadj = log10(age_at_scan)) %>% arrange(logAge_unadj)
vars <- c("TCV","Cortex","sGMV", "WMV", "Ventricles")
df$preterm <- as.factor(ifelse(df$GAbins_recode != "Term", "Preterm", "Term")) #combine VPM and LPM into one category
# Build the growth chart model
#Get the correct df
gc_all <- lapply(vars, 
                 function(x) {growthchart_model(
                   p = x, 
                   df = df)}) %>% set_names(vars)
gc_allGA <- lapply(vars, 
                   function(x) {growthchart_model(
                    p = x, 
                    df = df, 
                    agevar = "logAge", 
                    covs = c("sex", "GAbins_recode"), 
                    formula = "~fp(logAge, npoly=3) + sex + GAbins_recode - 1",
                    predictFUN = predictCentilesForAgeRange_GAbins)}) %>% set_names(vars)
gc_allPreterm <- lapply(vars, 
                   function(x) {growthchart_model(
                    p = x, 
                    df = df, 
                    agevar = "logAge", 
                    covs = c("sex", "preterm"), 
                    formula = "~fp(logAge, npoly=3) + sex + preterm - 1",
                    predictFUN = predictCentilesForAgeRange_preterm)}) %>% set_names(vars)
```
###Plotting the Curves
for term-born >37wks without any change to the model
only using logAge and sex.
```{r}
vars <- c("TCV","Cortex","sGMV", "WMV", "Ventricles")

plots <- lapply(seq_along(vars), function(i){growthChart_plot(p = vars[i], df = df, centileCurves = gc_all[[i]]$centileCurves, title = "")})
grid.arrange(grobs = plots[1:2], ncol = 2)

plotsGA <- lapply(seq_along(vars), function(i){growthChart_plot(p = vars[i], df = df, centileCurves = gc_allGA[[i]]$centileCurves, title = "", by.preterm = TRUE)})

plotsPreterm <- lapply(seq_along(vars), function(i){growthChart_plot(p = vars[i], df = df, centileCurves = gc_allPreterm[[i]]$centileCurves, title = "", by.preterm = TRUE)})
plotsPreterm[[1]]
plotsPreterm[[2]]
plotsPreterm[[3]]
plotsPreterm[[4]]
plotsPreterm[[5]]
```
#Play - LBCC
Got LBCC data from Lena
dHCP fetal
dHCP neonatal (25-40wk) 25% premature, many with term equivalent scan
CHILD fetal + neonatal (30-35wk fetal, no gestational age at birth info)
Harvard fetal (gestational age at scan 19-38)
BCP (adjusted age, all term born)
PING (30-43wk) 3-21 age
Conte (27-42wk) 6 timepoints
NIH (30-43wk) 5-25 age
PNC (~250 have GA/BW, 25-42wk) 8-21 age
TEBC (22-42wk) neonates
ABCD (10k)
FinnBrain
UKB (1200k)
SLIP

sum of NAs in LBCC for these vars (removing SLIP) total N = 17286
total_GM - 4157*
total_WM - 15460
CSF - 1538*
ventricles - 4027*
total_GMWM - 16831
cort_GM - 13924
cort_WM - 15226
subc_GM - 2808*
subc_WM - 15473
brainMaskVol - 1660
birth_height - 16795
birth_weight - 14705
birth_headcircumference - 17254
height_at_scan - 16066
weight_at_scan - 16063

##Load Data
! File saved at the end is not filtered out for only "unique" IDs ie one scan per participant.
```{r}
lbcc <- load_data(names = "lbcc", lbcc_ga_file) %>% bind_rows(.) %>%  select(-1, -2) #drop first two columns, repeat of row numbers
length(unique(lbcc$participant))#15779 unique participant IDs
```
No of NAs in 
PCW at birth - 603
PCW at birth recoded - 338
GA bins - 308
```{r}
#fix some columns in lbcc
lbcc <- lbcc %>% rename(hippocampi_and_amygdalae = hippocampi_and_amygdale) %>% mutate(PC_days_at_scan = PCW_at_scan*7, PCW_at_birth_recoded = as.numeric(PCW_at_birth_recoded)) %>% mutate(logAge = log10(PC_days_at_scan)) #NA by coercion are ones that are encoded as "fetal" under PCW_at_birth_recoded
lbcc$sex <- as.factor(lbcc$sex)
levels(lbcc$sex) <- c("F", "F", "M", "M")
lbcc$study_site <- as.factor(paste(lbcc$study, lbcc$site, sep = "_"))
lbcc$study_recode <- as.factor(lbcc$study)
#fix column names to match lbcc dataframe
slip_GASsQc <- read.csv("/Users/ekafadar/Documents/Grad_School/BGDLab/SLIP_data/SLIP_GA_SsQC_65.csv")
slip_GASsQc <- slip_GASsQc %>% mutate(total_GM = Cortex + sGMV, thalamus = right.thalamus + left.thalamus, hippocampus = right.hippocampus+left.hippocampus, putamen = right.putamen + left.putamen, hippocampi_and_amygdalae = right.hippocampus + left.hippocampus + right.amygdala + left.amygdala) %>% 
  rename(participant = subject_id, PCW_at_birth_recoded = gestational_age, study = study_id, CSF = csf, total_WM = WMV, ventricles = Ventricles, brainMaskVol = TCV, cort_GM = Cortex, subc_GM = sGMV, cerebellum = CerebellumVolume, GAbins = preterm, PC_days_at_scan = adjusted_age_in_days, birth_weight = birth_weight_kg, birth_height = birth_length_cm)
slip_GASsQc$study_recode <- as.factor(rep("SLIP", length(slip_GASsQc$study)))
slip_GASsQc$study_site <- as.factor(rep("SLIP", length(slip_GASsQc$study)))
```

Combine lbcc and slip dataframes
```{r}
#bind dfs
lbcc <- lbcc %>% filter(study != "SLIP")#17286
lbcc_slip <- bind_rows(lbcc, slip_GASsQc) %>% arrange(logAge)#17546
write.csv(lbcc_slip, file = "/Users/ekafadar/Documents/Grad_School/BGDLab/SLIP_data/lbcc_slip_GA_combo.csv", quote = F, row.names = F)
```


Duplicate IDs problem
```{r}
test_lbcc <- lbcc[duplicated(lbcc$participant),] #2381
table(test_lbcc$study)
test_lbcc$IDStudy <- paste0(test_lbcc$participant, test_lbcc$study)
sum(duplicated(test_lbcc$IDStudy))
test <- lbcc_slip[duplicated(lbcc_slip$participant),] #2381
table(test$study) #lots of slip rows in the "duplicated IDs" table
test_slip <- slip_GASsQc[duplicated(slip_GASsQc$participant),] #no duplicated within the slip dataset
test <- lbcc_slip[duplicated(lbcc_slip$subject_study),] #2380
table(test$study)
```

##Inspect Data Distribution
~10K from ABCD (over 50% of data points)
Harvard fetal and dHCP data - aren't born yet lol.
DCHS study might not be appropriate, it is a dataset of southafrican moms & babies. Delete it!
CONTE & CHILD & TEBC do not have regional info (but might have for subcortical volumes)
!!Add the SLIP scans to this dataset.
```{r}
table(lbcc$study)
sum(!is.na(lbcc$PCW_at_birth)) #16683
sum(!is.na(lbcc$PCW_at_birth_recoded))#16683
range(na.omit(lbcc$PCW_at_birth))#[2 50]
boxplot(lbcc$PCW_at_birth)
boxplot(lbcc$PCW_at_scan)
hist(lbcc$PCW_at_scan)

#Preterm categories (broad)
# Create a new column indicating cut points: specifying by weeks.
lbcc$preterm <- cut(lbcc$PCW_at_birth, breaks = c(-Inf, 31.9, 36.9, Inf), labels = c("VPM", "LPM", "Term"), include.lowest = TRUE)
table(lbcc$preterm)
table(lbcc[match(unique(lbcc$participant), lbcc$participant),"preterm"])
table(lbcc[match(unique(lbcc_slip$participant), lbcc$participant),"GAbins"])
```

For lbcc-slip combo
!! idk why recoding the factor level names is not working :(
```{r}
table(lbcc_slip$study)
table(subset(lbcc_slip, !is.na(PCW_at_birth_recoded))$study)
sum(!is.na(lbcc_slip$PCW_at_birth)) #18392
sum(!is.na(lbcc_slip$PCW_at_birth_recoded)) #18652
sum(!is.na(lbcc_slip$PC_days_at_scan)) #19255
range(na.omit(lbcc_slip$PCW_at_birth))#[2 50]
range(na.omit(lbcc_slip$PCW_at_birth_recoded))#[2 50]
boxplot(lbcc_slip$PCW_at_birth_recoded, ylab = "PCW at birth")
boxplot(lbcc_slip$PC_days_at_scan, ylab = "PC Days at scan")
hist(lbcc_slip$PCW_at_birth)
hist(lbcc_slip$PC_days_at_scan)
```
##Combined Data Load (pre-saved)
```{r}
#Preterm categories (broad)
# Create a new column indicating cut points: specifying by weeks.
lbcc_slip <- read.csv("/Users/ekafadar/Documents/Grad_School/BGDLab/SLIP_data/lbcc_slip_GA_combo.csv")
lbcc_slip$preterm <- cut(lbcc_slip$PCW_at_birth_recoded, breaks = c(-Inf, 31.9, 36.9, Inf), labels = c("VPM", "LPM", "Term"), include.lowest = TRUE)
lbcc_slip$GAbins_recode <- as.character(lbcc_slip$preterm)
lbcc_slip$GAbins_recode[lbcc_slip$GAbins == "fetal"] <- "fetal"
lbcc_slip$GAbins_recode <- as.factor(lbcc_slip$GAbins_recode)
lbcc_slip$sex <- as.factor(lbcc_slip$sex)
table(lbcc_slip$GAbins_recode)
lbcc_slip$subject_study <- as.factor(paste0(lbcc_slip$participant, lbcc_slip$study))
lbcc_slip$study_recode <- as.factor(lbcc_slip$study_recode)
lbcc_slip$study <- as.factor(lbcc_slip$study)
lbcc_slip$study_site <- as.factor(lbcc_slip$study_site)
table(lbcc_slip[match(unique(lbcc_slip$participant), lbcc_slip$participant),"preterm"])
table(lbcc_slip[match(unique(lbcc_slip$participant), lbcc_slip$participant),"GAbins_recode"])

```
##Plotting the raw data
###All data
```{r}
# List of variables to plot
vars_to_plot <- exprs(total_GM, CSF, ventricles, subc_GM, brainMaskVol, cerebellum, thalamus, weight_at_scan)
df <- lbcc_slip[match(unique(lbcc_slip$participant), lbcc_slip$participant),] %>% filter(!is.na(GAbins_recode) & (PC_days_at_scan/365) <= 25 & GAbins_recode != "fetal")
# Create plots for each variable
plots <- lapply(vars_to_plot, function(var) {
  group_smooth(df, GAbins_recode, !!var, log10(PC_days_at_scan))
})

# Assume plots is a list of ggplot plots
grid.arrange(grobs = plots[1:4], ncol = 2)
grid.arrange(grobs = plots[5:8], ncol = 2)

hist(df$PC_days_at_scan)
```
###Age Constrained
```{r}
# List of variables to plot
vars_to_plot <- exprs(total_GM, CSF, ventricles, subc_GM, brainMaskVol, cerebellum, thalamus, weight_at_scan)
df <- lbcc_slip %>% filter(!is.na(GAbins_recode) & (PC_days_at_scan/365) <= 2 & GAbins_recode != "fetal") %>% distinct(participant, .keep_all = T)
test <- lbcc_slip %>% filter(!is.na(GAbins_recode) & GAbins_recode != "fetal") %>% distinct(participant, .keep_all = T)
# Create plots for each variable
plots <- lapply(vars_to_plot, function(var) {
  group_smooth(df, GAbins_recode, !!var, log10(PC_days_at_scan))
})

# Assume plots is a list of ggplot plots
grid.arrange(grobs = plots[1:4], ncol = 2) 
grid.arrange(grobs = plots[5:8], ncol = 2)
```

##GAMLSS


###Models v1 - no study fx, no interaction, no fetal; global tissue-level phenotypes
Age at peaks calculation needs to be adjusted for the new output of the centileCurves!
Regular Model
```{r}
vars <- c("total_GM", "subc_GM", "total_WM", "ventricles")
# Build the growth chart model
#Get the correct df
df <- lbcc_slip[match(unique(lbcc_slip$subject_study), lbcc_slip$subject_study),] %>% filter(!is.na(GAbins_recode) & GAbins_recode != "fetal") %>% arrange(logAge)#1707
#hist(df$PC_days_at_scan, breaks = 200)

gc_all <- lapply(vars, function(x) {growthchart_model(p = x, df = df)}) %>% set_names(vars)

# Calculate the age at peak (median) phenotype value
#ageAtPeakSs <- 10^(sort(dfSsterm$logAge)[which.max(medianCentileSs)])
```

Who are these kids with like really weirdly high total_WM scores and they are also the youngest??? --- 
Per Lena: remove the first few data points due to edge effects.
```{r}
df <- lbcc_slip[match(unique(lbcc_slip$subject_study), lbcc_slip$subject_study),] %>% filter(!is.na(GAbins_recode) & GAbins_recode != "fetal" & PC_days_at_scan <= 2200) %>% arrange(logAge) #1707
t <- df %>% filter(logAge < 2.75 & total_WM >= 400000)
plot(t$logAge, t$total_WM)
table(t$study) #all dHCP
ggplot(lbcc_slip, aes(x = logAge,  y = total_WM, color = study)) + geom_point(alpha = 0.3) + theme_minimal()

ggplot(df, aes(x = logAge,  y = total_WM, color = study)) + geom_point(alpha = 0.3) + theme_minimal()
```

models including GA status (categorical)
**total_GM only has one VPM when age <= 1K days(might just need to model with VPM level dropped)
```{r}
vars <- c("total_GM", "subc_GM", "total_WM", "ventricles") 
# df <- lbcc_slip[match(unique(lbcc_slip$subject_study), lbcc_slip$subject_study),] %>% filter(!is.na(GAbins_recode) & GAbins_recode != "fetal" & PC_days_at_scan <= 2200) %>% arrange(logAge) #1707
df <- lbcc_slip[match(unique(lbcc_slip$subject_study), lbcc_slip$subject_study),] %>% filter(!is.na(GAbins_recode) & GAbins_recode != "fetal") %>% arrange(logAge) #14631
df$GAbins_recode <- droplevels(df$GAbins_recode, exclude = "fetal")
hist(df$PC_days_at_scan, breaks = 200)

ggplot(df,(aes(x = logAge, y = total_GM, color = GAbins_recode))) + geom_point(alpha = 0.3) + theme_minimal()

gc_allGA <- lapply(vars, function(x) {growthchart_modelGA(p = x, df = df, covs = c("sex", "GAbins_recode"), formula = "~fp(logAge, npoly=3) + sex + GAbins_recode - 1")}) %>% set_names(vars)
```

###Models v2 - yes study fx, no interaction, no fetal; global tissue-level phenotypes
Age at peaks calculation needs to be adjusted for the new output of the centileCurves!
Regular Model
```{r}
vars <- c("total_GM", "subc_GM", "total_WM", "ventricles")
# Build the growth chart model
#Get the correct df
df <- lbcc_slip[match(unique(lbcc_slip$subject_study), lbcc_slip$subject_study),] %>% filter(!is.na(GAbins_recode) & GAbins_recode != "fetal") %>% arrange(logAge)#1707
#hist(df$PC_days_at_scan, breaks = 200)

test_me <- function(){
gc_all<- lapply(vars, function(x) {growthchart_model(p = x, df = df, covs = c("sex", "study_recode"), formula = "~fp(logAge, npoly=3) + sex + random(study_recode) - 1")})
}

test_me <- function(){
growthchart_model(p = "total_GM", df = df, covs = c("sex", "study_recode"), formula = "~fp(logAge, npoly=3) + sex + random(study_recode) - 1")}

test_me_GA <- function(){
growthchart_model(p = "total_GM", df = df, covs = c("sex","GAbins_recode", "study_recode"), formula = "~fp(logAge, npoly=3) + sex + GAbins_recode + re(study_recode) - 1", predictFUN = predictCentilesForAgeRange_GAbins)}

test_me()

test_meGA
#%>% set_names(vars)

# Calculate the age at peak (median) phenotype value
#ageAtPeakSs <- 10^(sort(dfSsterm$logAge)[which.max(medianCentileSs)])
```

Who are these kids with like really weirdly high total_WM scores and they are also the youngest??? --- 
Per Lena: remove the first few data points due to edge effects.
```{r}
df <- lbcc_slip[match(unique(lbcc_slip$subject_study), lbcc_slip$subject_study),] %>% filter(!is.na(GAbins_recode) & GAbins_recode != "fetal" & PC_days_at_scan <= 2200) %>% arrange(logAge) #1707
t <- df %>% filter(logAge < 2.75 & total_WM >= 400000)
plot(t$logAge, t$total_WM)
table(t$study) #all dHCP
ggplot(lbcc_slip, aes(x = logAge,  y = total_WM, color = study)) + geom_point(alpha = 0.3) + theme_minimal()

ggplot(df, aes(x = logAge,  y = total_WM, color = study)) + geom_point(alpha = 0.3) + theme_minimal()
```

###Models v3 - no study fx, no interaction fx, yes fetal data
```{r}
vars <- c("total_GM", "subc_GM", "total_WM", "ventricles") 
# df <- lbcc_slip[match(unique(lbcc_slip$subject_study), lbcc_slip$subject_study),] %>% filter(!is.na(GAbins_recode) & GAbins_recode != "fetal" & PC_days_at_scan <= 2200) %>% arrange(logAge) #1707
df <- lbcc_slip[match(unique(lbcc_slip$subject_study), lbcc_slip$subject_study),] %>% filter(!is.na(GAbins_recode)) %>% arrange(logAge)#14918
df[which(df$GAbins_recode == "fetal"), "GAbins_recode"] <- "Term"
df$GAbins_recode <- droplevels(df$GAbins_recode, exclude = "fetal")
hist(df$PC_days_at_scan, breaks = 200)

ggplot(df,(aes(x = logAge, y = total_GM, color = GAbins_recode))) + geom_point(alpha = 0.3) + theme_minimal()
ggplot(df,(aes(x = logAge, y = total_WM, color = GAbins_recode))) + geom_point(alpha = 0.3) + theme_minimal()
ggplot(df,(aes(x = logAge, y = subc_GM, color = GAbins_recode))) + geom_point(alpha = 0.3) + theme_minimal()
ggplot(df,(aes(x = logAge, y = ventricles, color = GAbins_recode))) + geom_point(alpha = 0.3) + theme_minimal()

gc_allGA <- lapply(vars, function(x) {growthchart_modelGA(p = x, df = df, covs = c("sex", "GAbins_recode"), formula = "~fp(logAge, npoly=3) + sex + GAbins_recode - 1")}) %>% set_names(vars)

#Plot
plots <- lapply(seq_along(vars), function(i){growthChart_plot(p = vars[i], df = df, centileCurves = gc_allGA[[i]]$centileCurves, title = "", by.preterm = TRUE)})

plots[1]
plots[2]
plots[3]
plots[4]

```

###Plotting the Curves -- CHANGE THIS TO PLOT AFTER EACH MODEL VERSION
```{r}
df <- lbcc_slip[match(unique(lbcc_slip$subject_study), lbcc_slip$subject_study),] %>% filter(!is.na(GAbins_recode) & GAbins_recode != "fetal" & PC_days_at_scan <= 1000) %>% arrange(logAge)#1707

#No GA
vars <- c("total_GM", "subc_GM", "total_WM", "ventricles")
plots <- lapply(seq_along(vars), function(i){growthChart_plot(p = vars[i], df = df, centileCurves = gc_all[[i]]$centileCurves, title = "")})
grid.arrange(grobs = plots[c(1,2,3,4)], ncol = 2)
#GA
vars <- c("subc_GM", "total_WM", "ventricles") #total_GM only has one VPM (might just need to model with VPM level dropped)
plotsGA <- lapply(seq_along(vars), function(i){growthChart_plot(p = vars[i], df = df, centileCurves = gc_allGA[[i]]$centileCurves, title = "", by.preterm = TRUE)})
grid.arrange(grobs = plotsGA[1:4], ncol = 2) #plot doesn't actually look nice. Legend repeated many times etc, need to figure this out later.

growthChart_plot(p = "total_GM", df = df, centileCurves = gc_allGA$total_GM$centileCurves, title = "", by.preterm = TRUE)
growthChart_plot(p = "subc_GM", df = df, centileCurves = gc_allGA$subc_GM$centileCurves, title = "", by.preterm = TRUE)
growthChart_plot(p = "ventricles", df = df, centileCurves = gc_allGA$ventricles$centileCurves, title = "", by.preterm = TRUE)
growthChart_plot(p = "total_WM", df = df, centileCurves = gc_allGA$total_WM$centileCurves, title = "", by.preterm = TRUE)

growthChart_plot(p = "total_WM", df = df, centileCurves = gc_all$total_WM$centileCurves, title = "") + ylim(c(0,500000))

plot(gc_allGA$total_WM$centileCurves[[4]]$logAge, gc_allGA$total_WM$centileCurves[[4]]$Term)
plot(gc_allGA$total_WM$centileCurves[[4]]$logAge, gc_allGA$total_WM$centileCurves[[5]]$Term)
plot(gc_allGA$total_WM$centileCurves[[4]]$logAge, gc_allGA$total_WM$centileCurves[[6]]$Term)
plot(gc_allGA$total_WM$centileCurves[[4]]$logAge, gc_allGA$total_WM$centileCurves[[7]]$Term)

plot(gc_all$total_WM$centileCurves[[4]]$logAge, gc_all$total_WM$centileCurves[[4]]$median)
plot(gc_all$total_WM$centileCurves[[4]]$logAge, gc_all$total_WM$centileCurves[[5]]$median)
plot(gc_all$total_WM$centileCurves[[4]]$logAge, gc_all$total_WM$centileCurves[[6]]$median)
plot(gc_all$total_WM$centileCurves[[4]]$logAge, gc_all$total_WM$centileCurves[[7]]$median)
ggplot(df, aes(x = logAge, y = total_WM, color = preterm)) + geom_point() + theme_minimal()

#figure out plotting issues with total_WM

#ggplot(df, aes(x = PC_days_at_scan, y = total_WM)) + geom_point()
plot(gc_all$total_WM$centileCurves[[4]]$logAge, gc_all$total_WM$centileCurves[[4]]$median, ylab = "50th Centile", xlab = "logAge", main = "Total WM, all sample <= 2.2K days, n = 780")
plot(gc_all$total_WM$centileCurves[[3]]$logAge, gc_all$total_WM$centileCurves[[3]]$median, ylab = "25th Centile", xlab = "logAge", main = "Total WM, all sample <= 2.2K days, n = 780")
plot(df$logAge, df$total_WM, ylab = "total WM", xlab = "logAge", main = "Total WM, all sample <= 2.2K days, n = 780")

growthChart_plot(p = "total_GM", df = df, centileCurves = gc_all[[1]]$centileCurves, title = "", by.sex = F)
plots[[3]]
```

#Play - ABCD
##Load Data

###loading raw data & cleanup
pivot wider time points
match up & merge data tables based on matching subject ID & eventname
lbcc_abcd N=10574
abcd_wide N=11868
participants overlap N=10574
add gestational age column from lbcc dataframe Lena sent
devhx_12a_p -- was the child born prematurely? 1 - Yes, 0 - No, 999 - Don't know
devhx_ss_12_p -- how many weeks premature when born? (counting back from 40wks) (corrected), 999 - Don't know
devhx_12_p -- above but not corrected, so there are no '0's
TRY
- remove screener from the first loading list, and then merge and add screener again at the end (re-merge) -- DID NOT WORK
- remove other extra ones and try again ....
```{r}
abcd_data <- load_data(names = c("abcd_vol_aseg", "abcd_demo", "abcd_medhx", "abcd_mri_adm", "abcd_longtrack"), c(abcd_vol_aseg_file, abcd_demo_file, abcd_medhx_file, abcd_mri_adm_file, abcd_ltrack_file))
abcd_long <- Reduce(function(x, y) merge(x, y, by = c("src_subject_id", "eventname"), all=TRUE), abcd_data, accumulate=FALSE)
abcd_screener <- read.csv(abcd_screen_file) %>% select(-eventname) #drop "eventname" column because the variables in the screener are one-time values (not longitudinally changing)
abcd_long <- merge(abcd_long, abcd_screener, by = "src_subject_id", all = TRUE)

#calculate total mri phenotypes
abcd_long$totalWM_cb <- abcd_long$smri_vol_scs_cbwmatterlh + abcd_long$smri_vol_scs_cbwmatterrh
abcd_long$totalWM_crb <- abcd_long$smri_vol_scs_crbwmatterlh + abcd_long$smri_vol_scs_crbwmatterrh
abcd_long$totalCTX_crb <- abcd_long$smri_vol_scs_crbcortexlh + abcd_long$smri_vol_scs_crbcortexrh

#convert all events to "months" baseline = 0
abcd_long$year <- NA
abcd_long$year <- gsub("_year_follow_up_y_arm_1$", "", abcd_long$eventname)
abcd_long[abcd_long$year %in% c("baseline_year_1_arm_1"),"year"] <- 0
abcd_long$month <- NA
abcd_long$month <- as.numeric(abcd_long$year) * 12
abcd_long[is.na(abcd_long$month),]$month <-  as.numeric(abcd_long[is.na(abcd_long$month),]$eventname %>% gsub("_month_follow_up_arm_1$", "", .))

#Get GA from the dhx survey, compare baseline & 4yr f/up reporting (if duplicated). Then use baseline reporting.
baseline_dev <- abcd_data$abcd_medhx[abcd_data$abcd_medhx$eventname == "baseline_year_1_arm_1",]
fouryear_dev <- abcd_data$abcd_medhx[abcd_data$abcd_medhx$eventname == "4_year_follow_up_y_arm_1",]
table(baseline_dev$devhx_12a_p)
table(fouryear_dev$devhx_12a_p)#only 30 responses, 3 "yes"
ids <- fouryear_dev[!is.na(fouryear_dev$devhx_12a_p), c("src_subject_id","devhx_12a_p", "devhx_12_p")] 
ids_base <-baseline_dev[which(baseline_dev$src_subject_id %in% ids$src_subject_id),  c("src_subject_id","devhx_12a_p", "devhx_12_p")]
## one subject reported "premature" in 4year f/up, but not at baseline (NDAR_INVL7KKBD44). one subject reported "premature" in baseline but not at 4year f/up (NDAR_INVEJHM574R). Both cases reported prematurity by 1 week (would correspond to 39 weeks GA). I will use the baseline reported value.
## In new column gestAge, reporting "don't know" to "premature or no" is encoded as NA (140) + 2 subjects had NA for this question. Total NA in gestAge is 142 reporting "don't know" to "how premature" is encoded as 0.
baseline_dev$gestAge <- ifelse(baseline_dev$devhx_12a_p %in% "0", 40, ifelse(baseline_dev$devhx_12a_p %in% "999", NA, ifelse(baseline_dev$devhx_12_p %in% "999", 0, 40 - baseline_dev$devhx_12_p)))
##Three subject IDs that do not have any data associated with them other than mri data(at baseline) and screener data. No demographics etc. Keep/Remove?
abcd_long <- merge(abcd_long, baseline_dev[,c("src_subject_id", "gestAge")], by = "src_subject_id", all = TRUE) #total 145 IDs w/o gestAge data. 3 of them as mentioned above do not have medhx data at all.

sum(is.na(abcd_long$gestAge)) # 1040 total NAs

dup_indices <- duplicated(abcd_long[, c("src_subject_id", "eventname")]) | duplicated(abcd_long[, c("src_subject_id", "eventname")], fromLast = TRUE)
sum(dup_indices) #0 duplicates - what we want.
rm(dup_indices)

# #get GA from the lbcc data table
# lbcc_abcd <- read.csv("/Users/ekafadar/Documents/Grad_School/BGDLab/SLIP_data/lbcc_slip_GA_combo.csv") %>% filter(study == "ABCD") 
# lbcc_abcd$participant <- gsub("sub-", "", lbcc_abcd$participant) %>% gsub("NDAR", "NDAR_", .)
# abcd_long <- merge(abcd_long, lbcc_abcd[,c("participant", "PCW_at_birth_recoded")], by.x = "src_subject_id", by.y = "participant", all.x = TRUE)
#convert age at interview to weeks (x4.3), and add the GA at birth in weeks

abcd_long$PCW_at_event <- as.numeric(abcd_long$interview_age)*4.34 + abcd_long$gestAge
sum(is.na(abcd_long$PCW_at_event)) #1048 NAs, 1040 gestAge NAs + 8 interview_age NAs
df <- abcd_long %>% filter(!is.na(demo_sex_v2))
df$sex <- as.factor(ifelse(df$demo_sex_v2 %in% "1", "M", ifelse(df$demo_sex_v2 %in% "2", "F", ifelse(df$demo_sex_v2 %in% "3", "I", NA))))
abcd_long <- merge(abcd_long, df[,c("src_subject_id", "sex")], by = "src_subject_id", all = TRUE) 
rm(df)
#convert to wide
scrn_names <- names(abcd_screener[,2:81])
values_cols <- setdiff(names(abcd_long), c("eventname", "src_subject_id", "gestAge", "sex", scrn_names))
abcd_wide <- abcd_long %>% pivot_wider(., names_from = "eventname", values_from = all_of(values_cols))

#define preterm categories
abcd_long$preterm <- as.factor(cut(abcd_long$gestAge, breaks = c(-Inf, 31.9, 36.9, Inf), labels = c("VPM", "LPM", "Term"), include.lowest = TRUE))
abcd_wide$preterm <- as.factor(cut(abcd_wide$gestAge, breaks = c(-Inf, 31.9, 36.9, Inf), labels = c("VPM", "LPM", "Term"), include.lowest = TRUE))

write.csv(abcd_wide, file = "/Users/ekafadar/Documents/Grad_School/BGDLab/ABCD_data/abcd_combined_wide_032524.csv", quote = F, row.names = F)
write.csv(abcd_long, file = "/Users/ekafadar/Documents/Grad_School/BGDLab/ABCD_data/abcd_combined_long_032524.csv", quote = F, row.names = F)

rm(abcd_data, abcd_screener, baseline_dev, fouryear_dev, ids, ids_base, scrn_names, values_cols)
```
###Look at data distribution
get global data
-total ventricles volume - smri_vol_scs_allventricles
-total white matter (cortex or also cerebellar?)
-total gray matter
-subC gray matter volume: smri_vol_scs_subcorticalgv

?? --- wm hypointensities: smri_vol_scs_wmhint

-- get GA at birth from the big LBCC table, see if there are any missing.
```{r}
abcd_wide <- read.csv("/Users/ekafadar/Documents/Grad_School/BGDLab/ABCD_data/abcd_combined_wide_032524.csv")
abcd_long <- read.csv("/Users/ekafadar/Documents/Grad_School/BGDLab/ABCD_data/abcd_combined_long_032524.csv")#48928
```
look at distribution of variables
```{r}
#look at distribution of gestational ages
sum(!is.na(abcd_wide$gestAge))#10414
hist(abcd_wide$gestAge)
table(abcd_wide$gestAge)
table(abcd_wide$preterm)
table(abcd_wide$sex)

#MRI phenotypes how many subjects with longitudinal data?
sum(!is.na(abcd_wide$smri_vol_scs_intracranialv_baseline_year_1_arm_1)) #11728 for baseline
sum(!is.na(abcd_wide$smri_vol_scs_intracranialv_baseline_year_1_arm_1) & !is.na(abcd_wide$smri_vol_scs_intracranialv_2_year_follow_up_y_arm_1))#8024
sum(!is.na(abcd_wide$smri_vol_scs_intracranialv_baseline_year_1_arm_1) & !is.na(abcd_wide$smri_vol_scs_intracranialv_2_year_follow_up_y_arm_1)& !is.na(abcd_wide$smri_vol_scs_intracranialv_4_year_follow_up_y_arm_1))#2631
#Preterm category distribution per available data
table(abcd_wide[!is.na(abcd_wide$smri_vol_scs_intracranialv_baseline_year_1_arm_1), "preterm"])# VPM  LPM Term  175 1425 9985 
table(abcd_wide[!is.na(abcd_wide$smri_vol_scs_intracranialv_baseline_year_1_arm_1) & !is.na(abcd_wide$smri_vol_scs_intracranialv_2_year_follow_up_y_arm_1),"preterm"])# VPM  LPM Term 115  995 6833 
table(abcd_wide[!is.na(abcd_wide$smri_vol_scs_intracranialv_baseline_year_1_arm_1) & !is.na(abcd_wide$smri_vol_scs_intracranialv_2_year_follow_up_y_arm_1)& !is.na(abcd_wide$smri_vol_scs_intracranialv_4_year_follow_up_y_arm_1),"preterm"])# VPM  LPM Term 42  315 2252 

#plot mri phenotypes longitudinally, grouped by gestational age.
vars_to_plot <- exprs(smri_vol_scs_intracranialv, smri_vol_scs_wholeb, totalWM_cb, smri_vol_scs_allventricles, smri_vol_scs_subcorticalgv, totalWM_crb, totalCTX_crb)
#Want them to be by age (where is the age column?), and colored by preterm status
# plots <- lapply(vars_to_plot, function(var) {
#   group_smooth(abcd_long, preterm, !!var, PCW_at_event)
# })
# the data points being plotted obscured the "smoothed" line
plots <- lapply(vars_to_plot, function(var) {
  group_smooth_onlyLine(abcd_long, preterm, !!var, PCW_at_event)
})
plots[1]
plots[2]
plots[3]
plots[4]
plots[5]
plots[6]
plots[7]

df <- abcd_long %>% filter(gestAge == "40" & sex %in% c("M", "F") & !is.na(smri_vol_scs_intracranialv)) %>% mutate(logAge = log10(PCW_at_event)) %>% group_by(src_subject_id)
three_fup_subIDs <- df[which(df$eventname == "4_year_follow_up_y_arm_1"), "src_subject_id"]
#look at how data looks longitudinally
plots <- lapply(vars_to_plot, function(var) {
  group_smooth(head(df[which(df$src_subject_id %in% three_fup_subIDs$src_subject_id),],15), src_subject_id, !!var, PCW_at_event)
})
plots[1]
plots[2]
plots[3]
plots[4]
plots[5]
plots[6]
plots[7]

vars <- c
# Assume plots is a list of ggplot plots -- difficult to see in grid
grid.arrange(grobs = plots[1:4], ncol = 2)
grid.arrange(grobs = plots[5:7], ncol = 2)
```
##Linear models
```{r}
vars <- c("smri_vol_scs_intracranialv", "smri_vol_scs_wholeb", "totalWM_cb", "smri_vol_scs_allventricles", "smri_vol_scs_subcorticalgv", "totalWM_crb", "totalCTX_crb")
df <- abcd_long %>% filter(gestAge == "40" & sex %in% c("M", "F") & !is.na(smri_vol_scs_intracranialv)) %>% mutate(logAge = log10(PCW_at_event))

lm <- nlme(vars[1] ~ 1 + PCW_at_event + sex + site_id_l + (1 | src_subject_id), data = df)
```


##GAMLSS
###Get a growthchart model of term born (40wks) folks
? include site effect as random effect ?
 **Dividing Outcome variable by 10K (the thing Lena said..) for more stable prediction? .. actual operation in Simon's code ...
too many data points to see the lines clearly. Also x-axis if messed up. Should be fixed.
Should fix inside the centile from phenotype function to remove rows where there are NAs!!!
```{r}
vars <- c("smri_vol_scs_intracranialv", "smri_vol_scs_wholeb", "totalWM_cb", "smri_vol_scs_allventricles", "smri_vol_scs_subcorticalgv", "totalWM_crb", "totalCTX_crb")
df <- abcd_long %>% filter(gestAge == "40" & sex %in% c("M", "F") & !is.na(smri_vol_scs_intracranialv)) %>% mutate(logAge = log10(PCW_at_event))

##TEST with one variable
gc_test <- growthchart_model(
  p = vars[1], 
  df = df, 
  predictFUN = predictCentiles_ABCD)

growthChart_plot(
  p = vars[1], 
  df = df, 
  centileCurves = gc_test$centileCurves, 
  title = "ABCD 40wk")
##too many data points to see the lines clearly. Also x-axis if messed up. Should be fixed.


#Get centile scores from phenotype for all subjects (all preterm categories)
#get centile values for phenotypes
centiles_ABCD <- calculatePhenotypeCentile_ABCD(
  model = gc_test$model, 
  measuredPhenotypeValue = df$smri_vol_scs_intracranialv, 
  logAge = df$logAge,
  sex = df$sex,
  df = df,
  surfaceHoles=c())


centiles_nonMPR <- lapply(seq_along(vars), function(i) {calculatePhenotypeCentile(gc_MPR[[i]]$model, get(paste0(vars[i],"_FALSE"), wide_data), wide_data$logAge, wide_data$sex, df = wide_data)})
plots <- lapply(seq_along(vars), function(i){ ggplot() + geom_point(aes(x = centiles_MPR[[i]], y =centiles_nonMPR[[i]])) + labs( x = "MPR", y = "non-MPR", title = paste0("Centile Scores,", vars[i],", n=317")) + theme_minimal()})

# Build the growth chart model
gc_all <- lapply(vars, 
                 function(x) {growthchart_model(
                   p = x, 
                   df = df)}) %>% set_names(vars)

plots <- lapply(seq_along(vars), function(i){growthChart_plot(p = vars[i], df = df, centileCurves = gc_all[[i]]$centileCurves, title = "")})
grid.arrange(grobs = plots[1:2], ncol = 2)

#get centile values for phenotypes
centiles_MPR <- lapply(seq_along(vars), function(i) {calculatePhenotypeCentile(gc_MPR[[i]]$model, get(paste0(vars[i],"_TRUE"), wide_data), wide_data$logAge, wide_data$sex, df = wide_data)})
centiles_nonMPR <- lapply(seq_along(vars), function(i) {calculatePhenotypeCentile(gc_MPR[[i]]$model, get(paste0(vars[i],"_FALSE"), wide_data), wide_data$logAge, wide_data$sex, df = wide_data)})
plots <- lapply(seq_along(vars), function(i){ ggplot() + geom_point(aes(x = centiles_MPR[[i]], y =centiles_nonMPR[[i]])) + labs( x = "MPR", y = "non-MPR", title = paste0("Centile Scores,", vars[i],", n=317")) + theme_minimal()})


```